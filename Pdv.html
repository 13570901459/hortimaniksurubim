<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PDV Hortimanik</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --horti-red:#e11d2b;
  --horti-dark:#9b141b;
  --bg:#1b263b;
  --panel:#24344d;
  --surface:#2d3e59;
  --border:#3b4a66;
  --text:#f1f5f9;
  --text2:#cbd5e1;
}
.horti-btn{background:linear-gradient(180deg,var(--horti-red),var(--horti-dark));color:#fff}
#productsList>div,#cartList>div{background:var(--surface);border-color:var(--border);color:#f1f5f9;}
.autocomplete-suggestions{
  background:var(--surface);border:1px solid var(--border);max-height:150px;overflow-y:auto;position:absolute;width:100%;z-index:50;
}
.autocomplete-suggestion{padding:4px;cursor:pointer;}
.autocomplete-suggestion:hover{background:#2d3e59;}
</style>
</head>
<body class="bg-[var(--bg)] text-gray-100">
<div class="max-w-[98%] mx-auto p-2">
<header class="flex items-center gap-4 mb-2 bg-[var(--panel)] p-3 rounded-lg shadow flex-wrap">
<img src="logo.png" alt="Logo Hortimanik" class="h-12 w-12 object-contain rounded-md bg-white p-1">
<div>
<h1 class="text-2xl font-extrabold text-white">HORTIMANIK — PDV</h1>
<p class="text-sm text-[var(--text2)]">Caixa registradora — Exportar para PDF ou WhatsApp</p>
</div>
<div class="ml-auto text-right">
<div class="text-sm text-[var(--text2)]">Telefone WhatsApp</div>
<input id="phoneInput" class="mt-1 border border-[var(--border)] rounded px-2 py-1 text-sm bg-[var(--surface)] text-white placeholder-gray-400" placeholder="Ex.: 55819XXXXXXXX">
</div>
</header>

<main class="grid grid-cols-1 lg:grid-cols-3 gap-4">
<section class="lg:col-span-1 max-h-[90vh] overflow-auto">
<details open class="mb-4 bg-[var(--panel)] p-4 rounded shadow">
<summary class="cursor-pointer font-semibold">Cadastrar produto</summary>
<form id="productForm" class="mt-3 grid gap-2">
<input id="pName" placeholder="Nome" class="p-2 rounded bg-[var(--surface)] border border-[var(--border)] text-white" required>
<div class="flex gap-2">
<select id="pUnit" class="p-2 rounded bg-[var(--surface)] border border-[var(--border)] text-white w-1/2">
<option value="UN">Un</option>
<option value="KG">Kg</option>
</select>
<input id="pPrice" type="number" step="0.01" placeholder="Preço" class="p-2 rounded bg-[var(--surface)] border border-[var(--border)] text-white w-1/2" required>
</div>
<button class="horti-btn px-3 py-2 rounded">Salvar</button>
</form>
</details>

<details open class="bg-[var(--panel)] p-4 rounded shadow">
<summary class="cursor-pointer font-semibold">Produtos cadastrados</summary>
<input id="searchProducts" placeholder="Buscar produto..." class="p-2 w-full rounded bg-[var(--surface)] border border-[var(--border)] text-white my-2">
<div id="productsList" class="space-y-2 max-h-96 overflow-auto"></div>
</details>
</section>

<section class="lg:col-span-2">
<div class="bg-[var(--panel)] p-4 rounded shadow h-[90vh] flex flex-col">
<h2 class="text-white font-bold mb-2">Caixa Registradora</h2>
<div class="flex flex-col lg:flex-row gap-4 flex-1">

<!-- Registrar venda -->
<div class="flex-1 flex flex-col relative">
<input id="searchSaleProduct" placeholder="Buscar produto..." class="p-2 rounded bg-[var(--surface)] border border-[var(--border)] text-white">
<div id="autocomplete" class="autocomplete-suggestions hidden"></div>
<div class="grid grid-cols-2 gap-2 mt-2">
<input id="saleQty" type="number" step="0.01" value="1" class="p-2 rounded bg-[var(--surface)] border border-[var(--border)] text-white">
<input id="salePrice" type="number" step="0.01" placeholder="Preço unitário" class="p-2 rounded bg-[var(--surface)] border border-[var(--border)] text-white">
</div>
<div class="mt-2 flex justify-between text-sm text-[var(--text2)]">
<span>Subtotal: <span id="saleSubtotal">R$0,00</span></span>
<button id="addToCartBtn" class="horti-btn px-3 py-1 rounded">Adicionar</button>
</div>
<div class="mt-4 flex-1 overflow-auto border border-[var(--border)] rounded p-2 bg-[var(--surface)]">
<div class="flex justify-between items-center mb-2">
<h3 class="font-semibold text-white">Carrinho</h3>
<button id="clearCartBtn" class="text-red-400 text-sm border border-red-600 px-2 py-1 rounded">Limpar</button>
</div>
<div id="cartList" class="space-y-2"></div>
</div>
</div>

<!-- Totais -->
<div class="w-full lg:w-1/3 flex flex-col border border-[var(--border)] rounded p-2 bg-[var(--surface)] mt-4 lg:mt-0">
<label class="text-sm">Taxa de entrega</label>
<input id="deliveryFee" type="number" step="0.01" value="0" class="p-2 rounded bg-[var(--panel)] text-white w-full">

<div class="mt-2 flex gap-2">
<input id="couponCode" placeholder="Cupom" class="p-2 rounded bg-[var(--panel)] text-white flex-1">
<button id="applyCouponBtn" class="horti-btn px-2 rounded">Aplicar</button>
</div>

<div class="mt-2">
<label>Cliente</label>
<input id="clientName" class="p-2 rounded bg-[var(--panel)] text-white w-full">
</div>

<div class="mt-2">
<label>Entrega</label>
<select id="deliveryType" class="p-2 rounded bg-[var(--panel)] text-white w-full">
<option value="Retirada">Retirada</option>
<option value="Entrega">Entrega</option>
</select>
<input id="clientAddress" placeholder="Endereço de entrega" class="hidden mt-2 p-2 rounded bg-[var(--panel)] text-white w-full">
</div>

<div class="mt-2">
<label>Pagamento</label>
<select id="paymentMethod" class="p-2 rounded bg-[var(--panel)] text-white w-full">
<option>Pix</option>
<option>Dinheiro</option>
<option>Cartão</option>
</select>
</div>

<div class="mt-3 border-t border-[var(--border)] pt-2 text-[var(--text2)]">
<div>Total itens: R$ <span id="totalItems">0.00</span></div>
<div>Desconto: R$ <span id="totalDiscount">0.00</span></div>
<div>Entrega: R$ <span id="totalDelivery">0.00</span></div>
<div class="text-lg font-bold text-white">Total: R$ <span id="grandTotal">0.00</span></div>
</div>

<div class="mt-2 space-y-2">
<button id="sendWhatsapp" class="horti-btn w-full py-2 rounded">Enviar WhatsApp</button>
<button id="exportPDF" class="horti-btn w-full py-2 rounded">Exportar PDF</button>
</div>

</div>
</div>
</section>
</main>
</div>

<script>
// Funções utilitárias
const $=id=>document.getElementById(id);
const money=v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
let products=JSON.parse(localStorage.getItem("products")||"[]");
let cart=[]; let discount=0;

// Render produtos cadastrados
function saveProducts(){localStorage.setItem("products",JSON.stringify(products));}
function renderProducts(f=""){
  const list=$("productsList");
  list.innerHTML="";
  products.filter(p=>p.name.toLowerCase().includes(f.toLowerCase())).forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="p-2 border rounded flex justify-between items-center text-sm";
    d.innerHTML=`<div>${p.name} (${p.unit}) - ${money(p.price)}</div>
    <div class="flex gap-1">
    <button class="text-blue-400 text-xs" onclick="editProduct(${i})">Editar</button>
    <button class="text-red-400 text-xs" onclick="deleteProduct(${i})">Excluir</button>
    </div>`;
    list.appendChild(d);
  });
}
function editProduct(i){
  const p=products[i];
  const name=prompt("Editar nome",p.name);
  if(name) p.name=name;
  const unit=prompt("Editar unidade",p.unit);
  if(unit) p.unit=unit;
  const price=prompt("Editar preço",p.price);
  if(price) p.price=parseFloat(price)||p.price;
  products[i]=p;
  // Atualiza carrinho automaticamente
  cart=cart.map(c=>c.name===p.name?{...c, price:p.price, unit:p.unit}:c);
  saveProducts();
  renderProducts();
  renderCart();
}
function deleteProduct(i){
  if(confirm("Deseja excluir este produto?")){products.splice(i,1);saveProducts();renderProducts();}
}

// Carrinho
function updateSubtotal(){
  const q=parseFloat($("saleQty").value)||0;
  const p=parseFloat($("salePrice").value)||0;
  $("saleSubtotal").textContent=money(q*p);
}
function addToCart(){
  const term=$("searchSaleProduct").value.trim();
  if(!term) return;
  const prod=products.find(p=>p.name.toLowerCase()===term.toLowerCase());
  let price=parseFloat($("salePrice").value)||0;
  let unit="UN";
  if(prod){price=prod.price;unit=prod.unit;}
  const qty=parseFloat($("saleQty").value)||0;
  if(qty<=0) return;
  cart.push({name:term,unit,qty,price,sub:qty*price});
  renderCart();
}
function renderCart(){
  $("cartList").innerHTML="";
  cart.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="p-2 border rounded flex justify-between items-center text-sm";
    d.innerHTML=`<div>${c.name} (${c.unit})<br><span class="text-gray-300">${c.qty} x ${money(c.price)} = ${money(c.sub)}</span></div>
    <div class="flex gap-1">
    <button class="text-yellow-400 text-xs" onclick="editCart(${i})">Editar</button>
    <button class="text-red-400 text-xs" onclick="removeCart(${i})">Excluir</button>
    </div>`;
    $("cartList").appendChild(d);
  });
  calcTotals();
}
function editCart(i){
  const c=cart[i];
  const qty=parseFloat(prompt("Editar quantidade",c.qty))||c.qty;
  c.qty=qty;
  c.sub=c.qty*c.price;
  cart[i]=c;
  renderCart();
}
function removeCart(i){cart.splice(i,1);renderCart();}
function calcTotals(){
  const total=cart.reduce((s,i)=>s+i.sub,0);
  const delivery=parseFloat($("deliveryFee").value)||0;
  const grand=total-discount+delivery;
  $("totalItems").textContent=total.toFixed(2);
  $("totalDiscount").textContent=discount.toFixed(2);
  $("totalDelivery").textContent=delivery.toFixed(2);
  $("grandTotal").textContent=grand.toFixed(2);
}

// Autocomplete
$("searchSaleProduct").addEventListener("input",e=>{
  const term=e.target.value.toLowerCase();
  const suggestions=products.filter(p=>p.name.toLowerCase().includes(term));
  const box=$("autocomplete");
  box.innerHTML="";
  if(term && suggestions.length>0){box.classList.remove("hidden");
    suggestions.forEach(p=>{
      const div=document.createElement("div");
      div.className="autocomplete-suggestion";
      div.textContent=p.name;
      div.onclick=()=>{ $("searchSaleProduct").value=p.name; $("salePrice").value=p.price; $("saleQty").value=(p.unit==="KG"?0.5:1); updateSubtotal(); box.classList.add("hidden"); };
      box.appendChild(div);
    });
  }else box.classList.add("hidden");
});

// WhatsApp e PDF
function sendWhatsApp(){
  if(cart.length===0) return alert("Carrinho vazio");
  const phone=$("phoneInput").value;
  const client=$("clientName").value||"Cliente";
  const type=$("deliveryType").value;
  const addr=(type==="Entrega")?("End: "+$("clientAddress").value):"Retirada na loja";
  const payment=$("paymentMethod").value;
  const items=cart.map(i=>`- ${i.name} ${i.qty} ${i.unit} x ${money(i.price)} = ${money(i.sub)}`).join("%0A");
  const msg=`Pedido Hortimanik%0ACliente: ${client}%0A${type} ${addr}%0APagamento: ${payment}%0AItens:%0A${items}%0ATotal: ${$("grandTotal").textContent}`;
  window.open(`https://wa.me/${phone}?text=${msg}`,"_blank");
}

async function exportPDF(){
  if(cart.length===0) return alert("Carrinho vazio");
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  doc.text("Hortimanik - Pedido",10,10);
  doc.text("Cliente: "+($("clientName").value||"Cliente"),10,20);
  const type=$("deliveryType").value;
  if(type==="Entrega") doc.text("Entrega: "+$("clientAddress").value,10,30);
  doc.text("Pagamento: "+$("paymentMethod").value,10,40);
  let y=50;
  cart.forEach(c=>{
    doc.text(`${c.name} (${c.unit}) - ${c.qty} x ${c.price.toFixed(2)} = ${c.sub.toFixed(2)}`,10,y);
    y+=10;
  });
  y+=10;
  doc.text("Total: "+$("grandTotal").textContent,10,y);
  doc.save("pedido.pdf");
}

// Inicialização
document.addEventListener("DOMContentLoaded",()=>{
  renderProducts();
  $("productForm").onsubmit=e=>{
    e.preventDefault();
    products.push({name:$("pName").value,unit:$("pUnit").value,price:parseFloat($("pPrice").value)||0});
    saveProducts(); renderProducts(); e.target.reset();
  };
  $("searchProducts").oninput=e=>renderProducts(e.target.value);
  $("saleQty").oninput=updateSubtotal;
  $("salePrice").oninput=updateSubtotal;
  $("addToCartBtn").onclick=addToCart;
  $("clearCartBtn").onclick=()=>{cart=[];renderCart();}
  $("deliveryFee").oninput=calcTotals;
  $("applyCouponBtn").onclick=()=>{
    const code=$("couponCode").value.trim().toUpperCase();
    discount=0;
    const total=cart.reduce((s,i)=>s+i.sub,0);
    if(code==="HORTI10") discount=total*0.1;
    if(code==="HORTI5") discount=total*0.05;
    calcTotals();
  };
  $("deliveryType").onchange=e=>{
    if(e.target.value==="Entrega") $("clientAddress").classList.remove("hidden");
    else $("clientAddress").classList.add("hidden");
  };
  $("sendWhatsapp").onclick=sendWhatsApp;
  $("exportPDF").onclick=exportPDF;
});
</script>
</body>
</html>
