<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Banca de Frutas</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background: #0d1b2a;
    color: #f1f1f1;
  }
  header {
    background: #1b263b;
    padding: 15px;
    text-align: center;
    color: #fff;
    font-size: 22px;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,.3);
  }
  .container { max-width: 1200px; margin: auto; padding: 15px; }
  .card {
    background: #1e2a47;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,.4);
  }
  .card h3 { margin-top: 0; color: #90e0ef; }
  .card input {
    margin: 5px; padding: 8px; border-radius: 5px; border: none; outline: none; width: 150px;
  }
  button {
    margin: 5px; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
  }
  .add-btn { background: #0077b6; color: white; }
  .print-btn { background: #00b4d8; color: white; }
  .edit-btn { background: #ffc107; color: #000; }
  .del-btn { background: #e63946; color: white; }
  .toggle-btn { background: #495057; color: #fff; }

  .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
  .search-input { padding: 8px; border-radius: 5px; border: none; width: 100%; max-width: 320px; }

  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #33415c; padding: 8px; text-align: center; }
  th { background: #003566; color: #fff; }
  tfoot td { font-weight: bold; background: #001d3d; color: #fff; }

  /* responsivo */
  @media (max-width: 768px) {
    .card input { display: block; width: 100%; margin-bottom: 10px; }
    table, thead, tbody, th, td, tr { display: block; }
    thead tr { display: none; }
    tbody tr { margin-bottom: 15px; background: #14213d; border-radius: 6px; padding: 10px; }
    td { text-align: right; padding-left: 50%; position: relative; border: none; border-bottom: 1px solid #33415c; }
    td::before { content: attr(data-label); position: absolute; left: 10px; font-weight: bold; color: #90e0ef; }
  }
</style>
</head>
<body>
<header>
  <i class="fa-solid fa-store"></i> Controle da Banca de Frutas
</header>

<div class="container">

  <!-- Adicionar Produto -->
  <div class="card">
    <h3><i class="fa-solid fa-box"></i> Adicionar Produto</h3>
    <label>Produto: <input id="produto"></label>
    <label>Valor Caixa (R$): <input id="valor" type="number" step="0.01"></label>
    <label>Qtd Caixa: <input id="qtd" type="number" step="0.01"></label>
    <label>Margem (%): <input id="margem" type="number" step="0.01"></label>
    <label>Pre√ßo Venda Unit. (R$): <input id="venda" type="number" step="0.01"></label>
    <small style="color:#90e0ef;display:block;margin-top:5px;">
      üëâ Preencha <b>Margem %</b> ou <b>Pre√ßo de Venda</b>. Se preencher os dois, o Pre√ßo de Venda tem prioridade.
    </small>
    <button class="add-btn" onclick="adicionarProduto()"><i class="fa-solid fa-plus"></i> Adicionar</button>
  </div>

  <!-- Gastos -->
  <div class="card">
    <h3><i class="fa-solid fa-wallet"></i> Gastos Extras</h3>
    <label>Descri√ß√£o: <input id="descGasto"></label>
    <label>Valor (R$): <input id="valorGasto" type="number" step="0.01"></label>
    <button class="add-btn" onclick="adicionarGasto()"><i class="fa-solid fa-plus"></i> Adicionar Gasto</button>
    <table>
      <thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
      <tbody id="tabelaGastos"></tbody>
    </table>
  </div>

  <!-- Lista de Produtos -->
  <div class="card">
    <h3><i class="fa-solid fa-list"></i> Lista de Produtos</h3>
    <div class="controls">
      <input type="text" id="search" onkeyup="searchProduct()" placeholder="Buscar produto..." class="search-input">
      <button onclick="toggleTabela()" class="toggle-btn">Recolher/Expandir Produtos</button>
    </div>

    <div id="tabela-container">
      <table id="tabelaProdutos" border="1" cellpadding="5" cellspacing="0" width="100%">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Valor Caixa</th>
            <th>Qtd Caixa</th>
            <th>Custo Unit.</th>
            <th>Margem (%)</th>
            <th>Pre√ßo Venda</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaProdutos"></tbody>
      </table>
    </div>
  </div>

  <!-- Resumo -->
  <div class="card">
    <h3><i class="fa-solid fa-chart-line"></i> Resumo Final</h3>
    <table>
      <tfoot>
        <tr><td>Total Compras</td><td id="totalCompra">R$ 0,00</td></tr>
        <tr><td>Total Gastos</td><td id="totalGastos">R$ 0,00</td></tr>
        <tr><td>Lucro Bruto</td><td id="lucroBruto">R$ 0,00</td></tr>
        <tr><td>Lucro L√≠quido</td><td id="lucroLiquido">R$ 0,00</td></tr>
      </tfoot>
    </table>
    <button class="print-btn" onclick="window.print()"><i class="fa-solid fa-print"></i> Imprimir</button>
  </div>
</div>

<script>
let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
let gastos = JSON.parse(localStorage.getItem("gastos")) || [];

function salvar() {
  localStorage.setItem("produtos", JSON.stringify(produtos));
  localStorage.setItem("gastos", JSON.stringify(gastos));
}
function formatar(valor) { return "R$ " + valor.toFixed(2).replace(".", ","); }

function atualizarTabelas() {
  // === preenche a TABELA DE PRODUTOS no TBODY correto ===
  const tbody = document.getElementById("listaProdutos");
  tbody.innerHTML = "";
  let totalCompra = 0, lucroBruto = 0;

  produtos.forEach((p,i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td data-label="Produto">${p.nome}</td>
      <td data-label="Valor Caixa">${formatar(p.valor)}</td>
      <td data-label="Qtd Caixa">${p.qtd}</td>
      <td data-label="Custo Unit.">${formatar(p.custo)}</td>
      <td data-label="Margem (%)">${parseFloat(p.margem).toFixed(2)}%</td>
      <td data-label="Pre√ßo Venda">${formatar(p.venda)}</td>
      <td data-label="A√ß√µes">
        <button class="edit-btn" onclick="editarProduto(${i})"><i class="fa-solid fa-pen"></i></button>
        <button class="del-btn" onclick="excluirProduto(${i})"><i class="fa-solid fa-trash"></i></button>
      </td>`;
    tbody.appendChild(tr);

    totalCompra += p.valor;
    lucroBruto += (p.venda - p.custo) * p.qtd; // ainda calculamos para o resumo
  });

  // === tabela de gastos ===
  const tabelaG = document.getElementById("tabelaGastos");
  tabelaG.innerHTML = "";
  let totalGastos = 0;
  gastos.forEach((g,i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td data-label="Descri√ß√£o">${g.desc}</td>
      <td data-label="Valor">${formatar(g.valor)}</td>
      <td data-label="A√ß√µes"><button class="del-btn" onclick="excluirGasto(${i})"><i class="fa-solid fa-trash"></i></button></td>`;
    tabelaG.appendChild(tr);
    totalGastos += g.valor;
  });

  document.getElementById("totalCompra").textContent = formatar(totalCompra);
  document.getElementById("totalGastos").textContent = formatar(totalGastos);
  document.getElementById("lucroBruto").textContent = formatar(lucroBruto);
  document.getElementById("lucroLiquido").textContent = formatar(lucroBruto - totalGastos);

  // mant√©m o filtro aplicado ap√≥s atualizar a lista
  const q = document.getElementById("search");
  if (q && q.value) searchProduct();
}

function adicionarProduto() {
  const nome = document.getElementById("produto").value;
  const valor = parseFloat(document.getElementById("valor").value);
  const qtd = parseFloat(document.getElementById("qtd").value);
  const margem = parseFloat(document.getElementById("margem").value);
  const vendaDigitada = parseFloat(document.getElementById("venda").value);

  if (!nome || !valor || !qtd) return alert("Preencha todos os campos obrigat√≥rios!");

  const custo = valor / qtd;
  let venda, margemFinal;

  if (!isNaN(vendaDigitada) && vendaDigitada > 0) {
    venda = vendaDigitada;
    margemFinal = ((venda / custo) - 1) * 100;
  } else if (!isNaN(margem) && margem > 0) {
    margemFinal = margem;
    venda = custo * (1 + margem/100);
  } else {
    return alert("Informe Margem (%) ou Pre√ßo de Venda!");
  }

  produtos.push({ nome, valor, qtd, custo, margem: parseFloat(margemFinal).toFixed(2), venda });
  salvar();
  atualizarTabelas();

  // limpar campos
  document.getElementById("produto").value = "";
  document.getElementById("valor").value = "";
  document.getElementById("qtd").value = "";
  document.getElementById("margem").value = "";
  document.getElementById("venda").value = "";
}

function editarProduto(i) {
  const p = produtos[i];
  const novoNome = prompt("Nome:", p.nome);
  const novoValor = parseFloat(prompt("Valor da caixa:", p.valor));
  const novaQtd = parseFloat(prompt("Qtd caixa:", p.qtd));
  const novaMargem = prompt("Margem % (ou deixe em branco):", p.margem);
  const novoVenda = prompt("Pre√ßo de Venda Unit. (ou deixe em branco):", p.venda);

  if (!novoNome || !novoValor || !novaQtd) return;

  const custo = novoValor / novaQtd;
  let venda, margemFinal;

  if (novoVenda && !isNaN(parseFloat(novoVenda))) {
    venda = parseFloat(novoVenda);
    margemFinal = ((venda / custo) - 1) * 100;
  } else if (novaMargem && !isNaN(parseFloat(novaMargem))) {
    margemFinal = parseFloat(novaMargem);
    venda = custo * (1 + margemFinal/100);
  } else {
    alert("Informe Margem ou Pre√ßo de Venda!");
    return;
  }

  produtos[i] = { nome: novoNome, valor: novoValor, qtd: novaQtd, custo, margem: parseFloat(margemFinal).toFixed(2), venda };
  salvar();
  atualizarTabelas();
}

function excluirProduto(i) {
  if (confirm("Excluir este produto?")) {
    produtos.splice(i,1);
    salvar();
    atualizarTabelas();
  }
}

function adicionarGasto() {
  const desc = document.getElementById("descGasto").value;
  const valor = parseFloat(document.getElementById("valorGasto").value);
  if (!desc || !valor) return alert("Preencha descri√ß√£o e valor!");
  gastos.push({ desc, valor });
  salvar();
  atualizarTabelas();
  document.getElementById("descGasto").value = "";
  document.getElementById("valorGasto").value = "";
}

function excluirGasto(i) {
  if (confirm("Excluir este gasto?")) {
    gastos.splice(i,1);
    salvar();
    atualizarTabelas();
  }
}

// === BUSCA instant√¢nea (agora sobre #listaProdutos) ===
function searchProduct() {
  const input = document.getElementById("search").value.toLowerCase();
  const rows = document.querySelectorAll("#listaProdutos tr");
  rows.forEach(row => {
    const produto = row.querySelector("td")?.innerText.toLowerCase() || "";
    row.style.display = produto.includes(input) ? "" : "none";
  });
}

// === Recolher/Expandir a tabela ===
function toggleTabela() {
  const tabela = document.getElementById("tabela-container");
  tabela.style.display = (tabela.style.display === "none") ? "block" : "none";
}

// inicia
atualizarTabelas();
</script>
</body>
</html>
