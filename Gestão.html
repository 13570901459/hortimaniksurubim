<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hortifruti Pro - Gest√£o Leandro</title>
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #4caf50;
            --danger: #d32f2f;
            --info: #0288d1;
            --bg: #f0f2f5;
            --dark: #263238;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 1200px; margin: auto; }

        header { background: var(--primary); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.5rem; }

        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { font-size: 1.1rem; color: var(--primary); margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; display: flex; justify-content: space-between; }

        /* Formul√°rio */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { display: block; font-size: 0.8rem; font-weight: bold; color: #666; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; background: #f1f8e9; }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-save { background: var(--primary); color: white; }
        .btn-edit-mode { background: var(--info) !important; color: white; }
        .btn-clear { background: #90a4ae; color: white; font-size: 0.8rem; padding: 10px; }

        /* Estilo da Nota do Fornecedor */
        .nota-fornecedor { border-left: 5px solid var(--primary); background: #fff; margin-bottom: 15px; padding: 10px; border-radius: 0 15px 15px 0; border: 1px solid #eee; border-left-width: 6px; }
        .nota-header { display: flex; justify-content: space-between; align-items: center; background: #f1f8e9; padding: 8px 12px; border-radius: 8px; margin-bottom: 10px; }
        .nota-header span { font-weight: bold; color: var(--dark); }

        .produto-item { padding: 10px; border-bottom: 1px solid #f0f0f0; position: relative; }
        .produto-item:last-child { border-bottom: none; }
        
        .grid-info { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.85rem; margin-top: 5px; }
        .valor-liquido { color: var(--primary); font-weight: bold; font-size: 0.95rem; }
        
        .item-actions { display: flex; gap: 10px; margin-top: 10px; }
        .act-btn { flex: 1; padding: 8px; border-radius: 8px; border: none; font-size: 0.75rem; font-weight: bold; color: white; }
        .act-edit { background: var(--info); }
        .act-del { background: var(--danger); }

        /* Resumo Fixo */
        .resumo-fixo { background: var(--dark); color: white; padding: 20px; border-radius: 20px; margin-top: 20px; }
        .resumo-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .resumo-destaque { font-size: 1.3rem; border-top: 1px solid #455a64; padding-top: 10px; margin-top: 10px; color: #64ffda; font-weight: bold; }

        @media (min-width: 768px) {
            .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üçé Hortifruti Leandro - Gest√£o</h1>
    </header>

    <div class="main-grid">
        <section class="card">
            <h2 id="formTitle">Novo Lan√ßamento</h2>
            <div class="form-row">
                <div style="grid-column: span 2;">
                    <label>Fornecedor</label>
                    <input type="text" id="forn" placeholder="Ex: TENENTE">
                </div>
            </div>
            <div class="form-row">
                <div style="grid-column: span 2;">
                    <label>Produto</label>
                    <input type="text" id="prod" placeholder="Ex: CAR√Å">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Custo Nota (R$)</label>
                    <input type="number" id="custo" step="0.01" inputmode="decimal">
                </div>
                <div>
                    <label>Qtd na Nota</label>
                    <input type="number" id="qtdC" inputmode="numeric">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Perda Movimento %</label>
                    <input type="number" id="perda" value="10">
                </div>
                <div>
                    <label>Definir por:</label>
                    <select id="tipoVenda" onchange="toggleLabel()">
                        <option value="margem">Margem %</option>
                        <option value="valor">Pre√ßo R$</option>
                    </select>
                </div>
            </div>
            <div>
                <label id="labelVenda">Margem de Lucro (%)</label>
                <input type="number" id="valorVenda" value="91" step="0.1">
            </div>

            <button onclick="salvar()" class="btn btn-save" id="btnSalvar">Salvar na Lista</button>
            <button onclick="limpar()" class="btn btn-clear">Limpar Campos</button>
        </section>

        <section>
            <h2 style="padding: 0 10px;">Notas e Produtos</h2>
            <div id="areaNotas">
                </div>

            <div id="resumoGeral"></div>
        </section>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('leandro_horti_db_v2')) || [];
    let editId = null;

    window.onload = atualizar;

    function toggleLabel() {
        const tipo = document.getElementById('tipoVenda').value;
        document.getElementById('labelVenda').innerText = tipo === 'margem' ? 'Margem de Lucro (%)' : 'Valor de Venda Direto (R$)';
    }

    function salvar() {
        const forn = document.getElementById('forn').value.toUpperCase().trim();
        const prod = document.getElementById('prod').value.toUpperCase().trim();
        const custo = parseFloat(document.getElementById('custo').value);
        const qtdC = parseFloat(document.getElementById('qtdC').value);
        const perda = parseFloat(document.getElementById('perda').value) / 100;
        const tipoV = document.getElementById('tipoVenda').value;
        const valorV = parseFloat(document.getElementById('valorVenda').value);

        if (!forn || !prod || isNaN(custo) || isNaN(qtdC)) {
            alert("Preencha Fornecedor, Produto, Custo e Quantidade!");
            return;
        }

        const vendavel = qtdC * (1 - perda);
        const custoReal = custo / vendavel;
        
        let vendaFinal, margemFinal;
        if (tipoV === 'margem') {
            vendaFinal = Math.ceil(custoReal * (1 + (valorV / 100)));
            margemFinal = valorV;
        } else {
            vendaFinal = valorV;
            margemFinal = ((vendaFinal / custoReal) - 1) * 100;
        }

        const fatBruto = vendavel * vendaFinal;
        const fatLiquido = fatBruto - custo; // Isso √© o lucro real do item

        const item = {
            id: editId || Date.now(),
            forn, prod, custo, qtdC, perdaPc: perda * 100,
            vendavel, custoReal, vendaFinal, margemFinal, fatBruto, fatLiquido
        };

        if (editId) {
            db = db.map(x => x.id === editId ? item : x);
            editId = null;
        } else {
            db.push(item);
        }

        localStorage.setItem('leandro_horti_db_v2', JSON.stringify(db));
        limpar();
        atualizar();
    }

    function editar(id) {
        const i = db.find(x => x.id === id);
        document.getElementById('forn').value = i.forn;
        document.getElementById('prod').value = i.prod;
        document.getElementById('custo').value = i.custo;
        document.getElementById('qtdC').value = i.qtdC;
        document.getElementById('perda').value = i.perdaPc;
        editId = id;
        document.getElementById('btnSalvar').innerText = "Atualizar Produto";
        document.getElementById('btnSalvar').classList.add('btn-edit-mode');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function excluir(id) {
        if(confirm("Remover este produto?")) {
            db = db.filter(x => x.id !== id);
            localStorage.setItem('leandro_horti_db_v2', JSON.stringify(db));
            atualizar();
        }
    }

    function limpar() {
        document.getElementById('prod').value = '';
        document.getElementById('custo').value = '';
        document.getElementById('qtdC').value = '';
        editId = null;
        document.getElementById('btnSalvar').innerText = "Salvar na Lista";
        document.getElementById('btnSalvar').classList.remove('btn-edit-mode');
    }

    function atualizar() {
        const area = document.getElementById('areaNotas');
        const resumo = document.getElementById('resumoGeral');
        area.innerHTML = '';
        
        let totalCustoGeral = 0;
        let totalLucroGeral = 0;

        const fornecedores = [...new Set(db.map(x => x.forn))];

        fornecedores.forEach(f => {
            const itens = db.filter(x => x.forn === f);
            let custoNota = 0;
            
            let notaHtml = `<div class="nota-fornecedor">
                <div class="nota-header">
                    <span>FORNECEDOR: ${f}</span>
                    <span id="total-${f}"></span>
                </div>`;
            
            itens.forEach(i => {
                custoNota += i.custo;
                totalCustoGeral += i.custo;
                totalLucroGeral += i.fatLiquido;
                
                notaHtml += `
                    <div class="produto-item">
                        <div style="font-weight:bold; color:var(--dark)">${i.prod}</div>
                        <div class="grid-info">
                            <div>Caixa: ${i.qtdC} | Vend: ${i.vendavel.toFixed(1)}</div>
                            <div>Custo Real: R$ ${i.custoReal.toFixed(2)}</div>
                            <div>Venda: <b>R$ ${i.vendaFinal.toFixed(2)}</b></div>
                            <div>Margem: ${i.margemFinal.toFixed(0)}%</div>
                        </div>
                        <div class="valor-liquido">Lucro L√≠quido: R$ ${i.fatLiquido.toFixed(2)}</div>
                        <div class="item-actions">
                            <button class="act-btn act-edit" onclick="editar(${i.id})">EDITAR</button>
                            <button class="act-btn act-del" onclick="excluir(${i.id})">EXCLUIR</button>
                        </div>
                    </div>
                `;
            });

            notaHtml += `</div>`;
            area.innerHTML += notaHtml;
            document.getElementById(`total-${f}`).innerText = `TOTAL NOTA: R$ ${custoNota.toFixed(2)}`;
        });

        if(db.length > 0) {
            resumo.innerHTML = `
                <div class="resumo-fixo">
                    <div class="resumo-row"><span>Total Investido:</span> <span>R$ ${totalCustoGeral.toFixed(2)}</span></div>
                    <div class="resumo-row resumo-destaque">
                        <span>LUCRO L√çQUIDO TOTAL:</span> 
                        <span>R$ ${totalLucroGeral.toFixed(2)}</span>
                    </div>
                    <p style="font-size: 0.7rem; color: #90a4ae; margin-top:10px; text-align:center;">*Lucro j√° calculado com 10% de perda e custos pagos.</p>
                </div>
            `;
        } else {
            resumo.innerHTML = '';
        }
    }
</script>

</body>
</html>
