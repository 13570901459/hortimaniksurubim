<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hortifruti Pro - Gest√£o Leandro</title>
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #388e3c;
            --accent: #fbc02d;
            --danger: #e53935;
            --info: #1e88e5;
            --bg: #eceff1;
            --text: #263238;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        
        header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; }

        /* Grid Principal para PC */
        .main-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; align-items: start; }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { font-size: 1.2rem; margin-top: 0; color: var(--secondary); border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* Formul√°rio Din√¢mico */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #546e7a; }
        input, select { width: 100%; padding: 12px; border: 2px solid #cfd8dc; border-radius: 8px; box-sizing: border-box; transition: 0.3s; font-size: 1rem; }
        input:focus { border-color: var(--primary); outline: none; background: #f1f8e9; }

        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; text-transform: uppercase; }
        
        .btn-add { background: var(--primary); }
        .btn-add:hover { background: var(--secondary); transform: translateY(-2px); }
        .btn-clear { background: #78909c; }
        .btn-edit-mode { background: var(--info) !important; }

        /* Tabela e Relat√≥rios */
        .table-container { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f8f9fa; color: #546e7a; padding: 12px; text-align: left; font-size: 0.8rem; text-transform: uppercase; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        tr:hover { background: #f1f8e9; }

        .badge-margem { background: var(--primary); color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .btn-icon { padding: 8px; font-size: 0.8rem; flex: none; width: auto; }

        /* Relat√≥rio de Fornecedor Estilizado */
        .fornecedor-block { margin-top: 20px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: #fafafa; }
        .resumo-final { background: var(--text); color: white; padding: 25px; border-radius: 12px; margin-top: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .resumo-final h3 { margin: 0; color: var(--accent); font-size: 1.5rem; }

        /* Responsividade Celular */
        @media (max-width: 992px) {
            .main-layout { grid-template-columns: 1fr; }
            body { padding: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üçé Sistema Hortifruti Leandro</h1>
        <p>Gest√£o de Custos, Vendas e Proje√ß√£o de Lucro</p>
    </header>

    <div class="main-layout">
        <section class="card">
            <h2 id="formTitle">‚ûï Novo Lan√ßamento</h2>
            <div class="form-group">
                <label>Fornecedor</label>
                <input type="text" id="forn" placeholder="Ex: TENENTE">
            </div>
            <div class="form-group">
                <label>Produto</label>
                <input type="text" id="prod" placeholder="Ex: CAR√Å">
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex: 1;">
                    <label>Custo Nota (R$)</label>
                    <input type="number" id="custo" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Qtd na Nota</label>
                    <input type="number" id="qtdC" placeholder="30">
                </div>
            </div>
            <div class="form-group">
                <label>Perda de Movimento (%)</label>
                <input type="number" id="perda" value="10">
            </div>
            <div class="form-group">
                <label>Definir Pre√ßo por:</label>
                <select id="tipoVenda" onchange="toggleVendaLabel()">
                    <option value="margem">Aplicar Margem (%)</option>
                    <option value="valor">Valor de Venda Direto (R$)</option>
                </select>
            </div>
            <div class="form-group">
                <label id="labelVenda">Margem de Lucro (%)</label>
                <input type="number" id="valorVenda" value="91" step="0.1">
            </div>
            
            <div class="btn-row">
                <button onclick="limpar()" class="btn-clear">Limpar</button>
                <button onclick="salvar()" class="btn-add" id="btnAction">Salvar Produto</button>
            </div>
        </section>

        <section>
            <div class="card">
                <h2>üìã Lista de Mercadorias</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fornecedor</th>
                                <th>Produto</th>
                                <th>Custo Real</th>
                                <th>Venda</th>
                                <th>Margem</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaItens"></tbody>
                    </table>
                </div>
            </div>

            <div id="relatorioDinamico"></div>
        </section>
    </div>

    <div id="resumoGeral"></div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('hortifruti_db')) || [];
    let editId = null;

    // Inicializar
    window.onload = () => atualizarInterface();

    function toggleVendaLabel() {
        const tipo = document.getElementById('tipoVenda').value;
        document.getElementById('labelVenda').innerText = tipo === 'margem' ? 'Margem de Lucro (%)' : 'Valor de Venda Direto (R$)';
    }

    function salvar() {
        const forn = document.getElementById('forn').value.toUpperCase();
        const prod = document.getElementById('prod').value.toUpperCase();
        const custo = parseFloat(document.getElementById('custo').value);
        const qtdC = parseFloat(document.getElementById('qtdC').value);
        const perda = parseFloat(document.getElementById('perda').value) / 100;
        const tipoV = document.getElementById('tipoVenda').value;
        const valorV = parseFloat(document.getElementById('valorVenda').value);

        if (!forn || !prod || isNaN(custo) || isNaN(qtdC)) {
            alert("‚ö†Ô∏è Preencha os dados b√°sicos de Fornecedor, Produto e Custo!");
            return;
        }

        // C√°lculos Solicitados
        const vendavel = qtdC * (1 - perda);
        const custoReal = custo / vendavel; // Custo baseado no que sobra para vender
        
        let vendaFinal, margemFinal;

        if (tipoV === 'margem') {
            vendaFinal = Math.ceil(custoReal * (1 + (valorV / 100))); // Arredondado conforme solicitado
            margemFinal = valorV;
        } else {
            vendaFinal = valorV;
            margemFinal = ((vendaFinal / custoReal) - 1) * 100;
        }

        const faturamento = vendavel * vendaFinal;
        const lucro = faturamento - custo;

        const item = {
            id: editId || Date.now(),
            forn, prod, custo, qtdC, perdaPc: perda * 100,
            vendavel, custoReal, vendaFinal, margemFinal, faturamento, lucro
        };

        if (editId) {
            db = db.map(x => x.id === editId ? item : x);
            editId = null;
            document.getElementById('btnAction').classList.remove('btn-edit-mode');
            document.getElementById('formTitle').innerText = "‚ûï Novo Lan√ßamento";
        } else {
            db.push(item);
        }

        localStorage.setItem('hortifruti_db', JSON.stringify(db));
        limpar();
        atualizarInterface();
    }

    function editar(id) {
        const item = db.find(x => x.id === id);
        document.getElementById('forn').value = item.forn;
        document.getElementById('prod').value = item.prod;
        document.getElementById('custo').value = item.custo;
        document.getElementById('qtdC').value = item.qtdC;
        document.getElementById('perda').value = item.perdaPc;
        
        editId = id;
        document.getElementById('btnAction').innerText = "Atualizar Dados";
        document.getElementById('btnAction').classList.add('btn-edit-mode');
        document.getElementById('formTitle').innerText = "üìù Editando Produto";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function excluir(id) {
        if(confirm("Deseja remover este item?")) {
            db = db.filter(x => x.id !== id);
            localStorage.setItem('hortifruti_db', JSON.stringify(db));
            atualizarInterface();
        }
    }

    function limpar() {
        document.getElementById('prod').value = '';
        document.getElementById('custo').value = '';
        document.getElementById('qtdC').value = '';
        editId = null;
        document.getElementById('btnAction').innerText = "Salvar Produto";
        document.getElementById('btnAction').classList.remove('btn-edit-mode');
        document.getElementById('formTitle').innerText = "‚ûï Novo Lan√ßamento";
    }

    function atualizarInterface() {
        const lista = document.getElementById('listaItens');
        const relArea = document.getElementById('relatorioDinamico');
        const resumoArea = document.getElementById('resumoGeral');
        
        lista.innerHTML = '';
        let totalInv = 0;
        let totalFat = 0;

        // Tabela Principal
        db.forEach(p => {
            lista.innerHTML += `
                <tr>
                    <td><strong>${p.forn}</strong></td>
                    <td>${p.prod}</td>
                    <td>R$ ${p.custoReal.toFixed(2)}</td>
                    <td>R$ ${p.vendaFinal.toFixed(2)}</td>
                    <td><span class="badge-margem">${p.margemFinal.toFixed(0)}%</span></td>
                    <td>
                        <button class="btn-icon btn-edit" onclick="editar(${p.id})">‚úèÔ∏è</button>
                        <button class="btn-icon btn-del" onclick="excluir(${p.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });

        // Relat√≥rio por Fornecedor
        const fornecedores = [...new Set(db.map(p => p.forn))];
        let relHtml = '';

        fornecedores.forEach(f => {
            const itens = db.filter(p => p.forn === f);
            let totalForn = 0;
            relHtml += `<div class="card fornecedor-block">
                <h3>üßæ NOTA: ${f}</h3>`;
            
            itens.forEach(i => {
                totalForn += i.custo;
                totalInv += i.custo;
                totalFat += i.faturamento;
                relHtml += `
                    <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                        <strong>${i.prod}</strong> | Compra: ${i.qtdC}kg/un | <span style="color:var(--danger)">Vend√°vel (-${i.perdaPc}%): ${i.vendavel.toFixed(1)}</span><br>
                        <small>Custo Real: R$ ${i.custoReal.toFixed(2)} | Venda: <strong>R$ ${i.vendaFinal.toFixed(2)}</strong> | Lucro Item: R$ ${i.lucro.toFixed(2)}</small>
                    </div>
                `;
            });
            relHtml += `<p style="text-align:right; font-weight:bold; margin-top:10px;">Total Pago ao Fornecedor: R$ ${totalForn.toFixed(2)}</p></div>`;
        });
        relArea.innerHTML = relHtml;

        // Resumo Geral
        if(db.length > 0) {
            resumoArea.innerHTML = `
                <div class="resumo-final">
                    <div>
                        <p style="margin:0; opacity:0.8;">Investimento Total</p>
                        <h3>R$ ${totalInv.toFixed(2)}</h3>
                    </div>
                    <div>
                        <p style="margin:0; opacity:0.8;">Faturamento Estimado</p>
                        <h3>R$ ${totalFat.toFixed(2)}</h3>
                    </div>
                    <div style="text-align:right">
                        <p style="margin:0; opacity:0.8;">LUCRO L√çQUIDO PROJETADO</p>
                        <h3 style="color:#00e676">R$ ${(totalFat - totalInv).toFixed(2)}</h3>
                    </div>
                </div>
                <button onclick="exportarRelatorio()" style="margin-top:20px; background:#546e7a; width:100%">Imprimir / Gerar PDF</button>
            `;
        } else {
            resumoArea.innerHTML = '';
        }
    }

    function exportarRelatorio() {
        window.print();
    }
</script>

</body>
</html>
