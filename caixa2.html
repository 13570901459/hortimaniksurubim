<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDV Hortifruti</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#1b263b] text-white min-h-screen">
  <div class="container mx-auto p-4">

    <!-- Cadastro de Produtos -->
    <h1 class="text-2xl font-bold mb-4">Cadastrar Produto</h1>
    <div class="flex flex-col md:flex-row gap-2 mb-4">
      <input id="productName" type="text" placeholder="Nome do produto" class="p-2 rounded text-black w-full">
      <input id="productUnit" type="text" placeholder="Unidade (ex: KG, UN)" class="p-2 rounded text-black w-full md:w-32">
      <input id="productPrice" type="text" placeholder="Preço (ex: 5,99)" class="p-2 rounded text-black w-full md:w-32">
      <button onclick="addProduct()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Cadastrar</button>
    </div>

    <!-- Importar/Exportar JSON -->
    <div class="flex gap-2 mb-4">
      <input type="file" id="importFile" accept="application/json" onchange="importProducts(event)" class="p-2 rounded bg-gray-700">
      <button onclick="exportProducts()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Exportar JSON</button>
    </div>

    <!-- Buscar Produto -->
    <input type="text" id="searchProduct" placeholder="Buscar produto..." onkeyup="searchProduct()" class="p-2 rounded text-black w-full mb-4">

    <!-- Lista de Produtos -->
    <h2 class="text-xl font-semibold mb-2">Produtos Cadastrados</h2>
    <div id="productList" class="space-y-2"></div>

    <hr class="my-6 border-gray-600">

    <!-- Carrinho -->
    <h2 class="text-xl font-semibold mb-2">Carrinho</h2>
    <div class="flex gap-2 mb-4">
      <input id="cartProduct" type="text" placeholder="Produto" class="p-2 rounded text-black w-full">
      <input id="cartQuantity" type="number" placeholder="Quantidade" class="p-2 rounded text-black w-32">
      <button onclick="addToCart()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded">Adicionar</button>
    </div>
    <div id="cartList" class="space-y-2"></div>
    <p id="cartTotal" class="font-bold mt-2">Total: R$ 0,00</p>

    <!-- Cupom -->
    <div class="flex gap-2 mt-4">
      <input id="coupon" type="text" placeholder="Cupom de desconto" class="p-2 rounded text-black w-full">
      <button onclick="applyCoupon()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">Aplicar</button>
    </div>

    <hr class="my-6 border-gray-600">

    <!-- Cliente -->
    <h2 class="text-xl font-semibold mb-2">Dados do Cliente</h2>
    <input id="clientName" type="text" placeholder="Nome do Cliente" class="p-2 rounded text-black w-full mb-2">
    <select id="deliveryOption" onchange="toggleAddress()" class="p-2 rounded text-black w-full mb-2">
      <option value="retirada">Retirar na Loja</option>
      <option value="entrega">Entrega</option>
    </select>
    <input id="clientAddress" type="text" placeholder="Endereço de Entrega" class="p-2 rounded text-black w-full mb-2 hidden">

    <!-- Pagamento -->
    <select id="paymentMethod" class="p-2 rounded text-black w-full mb-4">
      <option value="Pix">Pix</option>
      <option value="Dinheiro">Dinheiro</option>
      <option value="Cartão">Cartão</option>
    </select>

    <!-- Finalizar Pedido -->
    <div class="flex gap-2">
      <button onclick="exportPDF()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">Exportar PDF</button>
      <button onclick="sendWhatsApp()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Enviar WhatsApp</button>
    </div>
  </div>

  <script>
    let products = [];
    let cart = [];
    let discount = 0;

    // Cadastro produto
    function addProduct() {
      const name = document.getElementById("productName").value;
      const unit = document.getElementById("productUnit").value;
      let price = parseFloat(document.getElementById("productPrice").value.replace(",", "."));

      if (!name || isNaN(price)) {
        alert("Preencha corretamente os campos!");
        return;
      }

      products.push({ name, unit, price });
      renderProducts();
    }

    function renderProducts(filtered = products) {
      const list = document.getElementById("productList");
      list.innerHTML = "";
      filtered.forEach((p, i) => {
        const div = document.createElement("div");
        div.className = "p-2 bg-gray-800 rounded flex justify-between items-center";
        div.innerHTML = `
          <div>
            <strong>${p.name}</strong><br>
            ${p.unit} — ${(p.price).toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}
          </div>
          <div>
            <button onclick="editProduct(${i})" class="text-blue-400 mr-2">Editar</button>
            <button onclick="deleteProduct(${i})" class="text-red-400">Excluir</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    function editProduct(index) {
      const p = products[index];
      document.getElementById("productName").value = p.name;
      document.getElementById("productUnit").value = p.unit;
      document.getElementById("productPrice").value = p.price.toString().replace(".", ",");
      products.splice(index, 1);
      renderProducts();
    }

    function deleteProduct(index) {
      products.splice(index, 1);
      renderProducts();
    }

    function searchProduct() {
      const term = document.getElementById("searchProduct").value.toLowerCase();
      const filtered = products.filter(p => p.name.toLowerCase().includes(term));
      renderProducts(filtered);
    }

    // Importar JSON
    function importProducts(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const imported = JSON.parse(e.target.result);
        imported.forEach(p => {
          p.price = parseFloat(String(p.price).replace(",", "."));
          products.push(p);
        });
        renderProducts();
      };
      reader.readAsText(file);
    }

    function exportProducts() {
      const blob = new Blob([JSON.stringify(products, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "produtos.json";
      a.click();
    }

    // Carrinho
    function addToCart() {
      const name = document.getElementById("cartProduct").value;
      const qty = parseFloat(document.getElementById("cartQuantity").value.replace(",", "."));
      const product = products.find(p => p.name.toLowerCase() === name.toLowerCase());

      if (!product || isNaN(qty)) {
        alert("Produto ou quantidade inválidos!");
        return;
      }

      cart.push({ ...product, qty });
      renderCart();
    }

    function renderCart() {
      const list = document.getElementById("cartList");
      list.innerHTML = "";
      let total = 0;
      cart.forEach((c, i) => {
        const subtotal = c.price * c.qty;
        total += subtotal;
        const div = document.createElement("div");
        div.className = "p-2 bg-gray-700 rounded flex justify-between items-center";
        div.innerHTML = `
          <div>
            ${c.qty} ${c.unit} — ${c.name}<br>
            ${(subtotal).toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}
          </div>
          <div>
            <button onclick="removeFromCart(${i})" class="text-red-400">Excluir</button>
          </div>
        `;
        list.appendChild(div);
      });
      total -= discount;
      document.getElementById("cartTotal").textContent = "Total: " + total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function removeFromCart(i) {
      cart.splice(i, 1);
      renderCart();
    }

    function applyCoupon() {
      const code = document.getElementById("coupon").value;
      if (code === "DESCONTO10") {
        discount = 10;
        alert("Cupom aplicado: R$ 10,00 de desconto!");
      } else {
        discount = 0;
        alert("Cupom inválido!");
      }
      renderCart();
    }

    // Cliente
    function toggleAddress() {
      const option = document.getElementById("deliveryOption").value;
      document.getElementById("clientAddress").classList.toggle("hidden", option !== "entrega");
    }

    // Exportar PDF
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.text("Pedido Hortifruti", 10, 10);

      const rows = cart.map(c => [c.name, c.qty + " " + c.unit, c.price.toFixed(2), (c.price * c.qty).toFixed(2)]);
      doc.autoTable({
        head: [["Produto", "Qtd", "Preço", "Subtotal"]],
        body: rows
      });

      doc.save("pedido.pdf");
    }

    // WhatsApp
    function sendWhatsApp() {
      let msg = "Pedido Hortifruti:%0A";
      cart.forEach(c => {
        msg += `${c.qty} ${c.unit} - ${c.name}: R$ ${(c.price * c.qty).toFixed(2)}%0A`;
      });
      msg += document.getElementById("cartTotal").textContent;
      const url = `https://wa.me/?text=${msg}`;
      window.open(url, "_blank");
    }
  </script>
</body>
</html>

