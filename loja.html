<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HORTIMANIK - Dashboard (debug)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0f1724; }
    .card { background: linear-gradient(180deg,#0b1220 0%, #07101a 100%); border: 1px solid rgba(255,255,255,0.03); }
    .btn-red { background: linear-gradient(180deg,#ef4444,#dc2626); }
    .btn-red:hover { filter: brightness(0.9); }
    .small-btn { font-size: 12px; padding: 4px 8px; }
    input[type="text"], input[type="date"] { -moz-appearance: textfield; }
    #initStatus { position: fixed; left: 260px; right: 20px; top: 18px; z-index: 60; padding: 8px 12px; border-radius: 8px; font-weight:600; }
  </style>
</head>
<body class="text-slate-200 font-sans">
  <div id="initStatus" class="text-slate-800 bg-sky-200">Iniciando HORTIMANIK...</div>

  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-80 p-6 bg-slate-900 border-r border-slate-800">
      <h1 class="text-2xl font-bold text-red-500">HORTIMANIK</h1>
      <p class="text-sm text-slate-400 mb-4">Sistema de vendas & controle — Seg a Sáb</p>
      <nav class="space-y-2">
        <button data-tab="dashboard" class="tab-btn w-full text-left px-3 py-2 rounded card">Dashboard</button>
        <button data-tab="compras" class="tab-btn w-full text-left px-3 py-2 rounded card">Registrar Compras</button>
        <button data-tab="vendas" class="tab-btn w-full text-left px-3 py-2 rounded card">Registrar Vendas</button>
        <button data-tab="despesas" class="tab-btn w-full text-left px-3 py-2 rounded card">Registrar Despesas</button>
        <button data-tab="relatorios" class="tab-btn w-full text-left px-3 py-2 rounded card">Relatórios</button>
        <button data-tab="config" class="tab-btn w-full text-left px-3 py-2 rounded card">Config / Export</button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6 overflow-y-auto">
      <!-- Dashboard -->
      <section id="dashboard" class="tab-content">
        <div class="flex justify-between items-start gap-4">
          <div>
            <h2 class="text-2xl font-bold">Dashboard profissional</h2>
            <p class="text-sm text-slate-400">Visão rápida: compras, projeção, meta diária, vendas x meta e despesas.</p>
          </div>
          <div class="space-x-2">
            <label class="text-sm text-slate-400">Meta diária (R$)</label>
            <input id="metaDiaria" type="text" inputmode="decimal" class="px-3 py-1 rounded bg-slate-800 text-slate-200 w-36 text-right" />
            <label class="text-sm text-slate-400 ml-2">Meta semanal (R$)</label>
            <input id="metaSemanal" type="text" inputmode="decimal" class="px-3 py-1 rounded bg-slate-800 text-slate-200 w-36 text-right" />
            <button id="salvarMetas" class="px-3 py-1 rounded btn-red text-white ml-2">Salvar</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mt-6">
          <div class="p-4 rounded card shadow col-span-2">
            <div class="text-xs text-slate-400">Total compras (fornecedores)</div>
            <div id="totalCompras" class="text-2xl font-bold text-slate-100">R$ 0,00</div>
            <div class="text-sm text-slate-400">(soma de todos os registros de compra)</div>
          </div>

          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Valor venda estimado (com margem)</div>
            <div id="valorVendaEstimado" class="text-2xl font-bold text-red-400">R$ 0,00</div>
            <div class="text-sm text-slate-400">(total compras + margem)</div>
          </div>

          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Projeção diária (Venda estimada ÷ 6)</div>
            <div id="projecaoDiaria" class="text-2xl font-bold text-sky-400">R$ 0,00</div>
            <div class="text-sm text-slate-400">Seg → Sáb</div>
          </div>

          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Vendas (hoje)</div>
            <div id="vendasHoje" class="text-2xl font-bold text-green-400">R$ 0,00</div>
            <div id="metaStatus" class="text-sm text-slate-400 mt-1">Meta: R$ 0,00 — Faltam: R$ 0,00</div>
          </div>

          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Gastos (hoje)</div>
            <div id="gastosHoje" class="text-2xl font-bold text-yellow-400">R$ 0,00</div>
            <div class="text-sm text-slate-400">(despesas registradas hoje)</div>
          </div>

          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Lucro bruto estimado</div>
            <div id="lucroBrutoEstim" class="text-2xl font-bold text-indigo-300">R$ 0,00</div>
            <div class="text-sm text-slate-400">(venda estimada - custo das compras)</div>
          </div>
        </div>

        <!-- Novos cards semanais -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Total vendas (semana)</div>
            <div id="vendasSemana" class="text-2xl font-bold text-green-400">R$ 0,00</div>
            <div id="metaSemanaStatus" class="text-sm text-slate-400 mt-1">Meta semanal: R$ 0,00 — Faltam: R$ 0,00</div>
          </div>
          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Despesas (semana)</div>
            <div id="gastosSemana" class="text-2xl font-bold text-yellow-400">R$ 0,00</div>
            <div class="text-sm text-slate-400">(soma de todas as despesas da semana)</div>
          </div>
          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Lucro líquido (semana)</div>
            <div id="lucroSemana" class="text-2xl font-bold text-indigo-200">R$ 0,00</div>
            <div class="text-sm text-slate-400">(vendas semana - compras semana - despesas semana)</div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-6">
          <div class="p-4 rounded card shadow h-72">
            <canvas id="chartSemana" class="w-full h-full"></canvas>
          </div>
          <div class="p-4 rounded card shadow">
            <h3 class="text-lg font-semibold">Resumo financeiro (hoje)</h3>
            <div class="mt-3 text-sm text-slate-400">Vendas: <strong id="vendasHojeResumo">R$ 0,00</strong></div>
            <div class="text-sm text-slate-400">Despesas: <strong id="despesasHojeResumo">R$ 0,00</strong></div>
            <div class="text-sm text-slate-400">Custo compras do dia: <strong id="custoComprasHoje">R$ 0,00</strong></div>
            <div class="text-xl font-bold mt-3">Lucro líquido (hoje): <span id="lucroLiquido">R$ 0,00</span></div>
            <div class="mt-3 text-sm text-slate-400">Lucro líquido estimado (venda estimada - compras - despesas totais): <strong id="lucroLiquidoEstim">R$ 0,00</strong></div>
          </div>
        </div>
      </section>

      <!-- Compras -->
      <section id="compras" class="hidden tab-content mt-6">
        <h2 class="text-xl font-bold mb-3 text-red-400">Registrar Compras</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <input id="fornecedor" placeholder="Nome do fornecedor" class="p-2 rounded bg-slate-800 text-slate-200" />
          <input id="valorCompraInput" type="text" inputmode="decimal" placeholder="Valor da compra (R$)" class="p-2 rounded bg-slate-800 text-slate-200 text-right" />
          <input id="compraDataInput" type="date" class="p-2 rounded bg-slate-800 text-slate-200" />
          <button id="adicionarCompra" class="btn-red px-4 py-2 rounded font-bold">Adicionar compra</button>
        </div>

        <div class="mt-4 p-4 rounded card">
          <h3 class="font-semibold">Compras registradas</h3>
          <div class="mt-2 overflow-auto max-h-64">
            <table class="w-full text-sm text-left">
              <thead class="text-slate-400 text-xs"><tr><th>Data</th><th>Fornecedor</th><th>Valor</th><th></th></tr></thead>
              <tbody id="tabelaCompras"></tbody>
            </table>
          </div>
          <div class="mt-3 text-sm text-slate-400">Total compras: <strong id="somaCompras">R$ 0,00</strong></div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-2">
            <input id="margemInput" type="text" inputmode="decimal" step="0.1" placeholder="Margem % (ex: 30)" class="p-2 rounded bg-slate-800 text-slate-200 text-right" />
            <button id="calcularVendaEstim" class="px-4 py-2 rounded btn-red font-bold">Calcular venda estimada</button>
            <div class="text-slate-400 p-2">Preço venda estimado: <strong id="precoVendaEstim">R$ 0,00</strong></div>
          </div>
        </div>
      </section>

      <!-- Vendas -->
      <section id="vendas" class="hidden tab-content mt-6">
        <h2 class="text-xl font-bold mb-3 text-red-400">Registrar Vendas</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <input id="vendaDataInput" type="date" class="p-2 rounded bg-slate-800 text-slate-200" />
          <input id="vendaValorInput" type="text" inputmode="decimal" placeholder="Valor vendido (R$)" class="p-2 rounded bg-slate-800 text-slate-200 text-right" />
          <select id="vendaMetodoInput" class="p-2 rounded bg-slate-800 text-slate-200"><option>PIX</option><option>Cartão</option><option>Dinheiro</option></select>
          <button id="adicionarVenda" class="btn-red px-4 py-2 rounded font-bold">Registrar venda</button>
        </div>

        <div class="mt-4 p-4 rounded card">
          <h3 class="font-semibold">Vendas registradas</h3>
          <div class="mt-2 overflow-auto max-h-64">
            <table class="w-full text-sm text-left">
              <thead class="text-slate-400 text-xs"><tr><th>Data</th><th>Valor</th><th>Método</th><th></th></tr></thead>
              <tbody id="tabelaVendas"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Despesas -->
      <section id="despesas" class="hidden tab-content mt-6">
        <h2 class="text-xl font-bold mb-3 text-red-400">Registrar Despesas</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <input id="despesaDataInput" type="date" class="p-2 rounded bg-slate-800 text-slate-200" />
          <input id="despesaValorInput" type="text" inputmode="decimal" placeholder="Valor gasto (R$)" class="p-2 rounded bg-slate-800 text-slate-200 text-right" />
          <input id="despesaDescInput" placeholder="Descrição" class="p-2 rounded bg-slate-800 text-slate-200" />
          <button id="adicionarDespesa" class="btn-red px-4 py-2 rounded font-bold">Registrar despesa</button>
        </div>

        <div class="mt-4 p-4 rounded card">
          <h3 class="font-semibold">Despesas registradas</h3>
          <div class="mt-2 overflow-auto max-h-64">
            <table class="w-full text-sm text-left">
              <thead class="text-slate-400 text-xs"><tr><th>Data</th><th>Valor</th><th>Descrição</th><th></th></tr></thead>
              <tbody id="tabelaDespesas"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Relatórios -->
      <section id="relatorios" class="hidden tab-content mt-6">
        <h2 class="text-xl font-bold mb-3 text-red-400">Relatórios & Export</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <button id="exportCsvBtn" class="btn-red px-4 py-2 rounded font-bold">Exportar CSV</button>
          <button id="limparDados" class="px-4 py-2 rounded bg-rose-700">Limpar todos os dados</button>
          <div class="text-slate-400">Os dados ficam somente no seu navegador (localStorage).</div>
        </div>
      </section>

      <!-- Config -->
      <section id="config" class="hidden tab-content mt-6">
        <h2 class="text-xl font-bold mb-3 text-red-400">Configurações</h2>
        <div class="p-4 rounded card">
          <div class="text-slate-400">Storage size: <span id="storageSize">-</span></div>
        </div>
      </section>

    </main>
  </div>

  <script>
    /* ---------- UTILS E DEBUG ---------- */
    function qs(sel){ return document.querySelector(sel); }
    function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
    function setStatus(msg, isError){
      const s = qs('#initStatus');
      if(s){ s.textContent = msg; s.style.background = isError ? '#fecaca' : '#bae6fd'; s.style.color = isError ? '#7f1d1d' : '#0f1724'; }
      console[isError ? 'error':'log']('[HORTIMANIK] ' + msg);
    }
    function pad(n){ return String(n).padStart(2,'0'); }
    function formatCurrency(v){ const n = Number(v) || 0; return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
    function parseNumber(input){
      if(input===undefined||input===null) return 0;
      if(typeof input === 'number') return input;
      let s = String(input).trim();
      if(s==='') return 0;
      s = s.replace(/[^0-9,.-]/g,'');
      const hasDot = s.indexOf('.') !== -1;
      const hasComma = s.indexOf(',') !== -1;
      if(hasDot && hasComma){ s = s.replace(/\./g,'').replace(/,/g,'.'); }
      else { s = s.replace(/,/g,'.'); }
      const n = parseFloat(s);
      return isNaN(n)?0:n;
    }
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function getLocalDateString(d = new Date()){ return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); }

    /* ---------- STORAGE KEYS E ESTADO ---------- */
    const KEY_PUR = 'hortimanik_purchases_v4';
    const KEY_SALES = 'hortimanik_sales_v4';
    const KEY_EXP = 'hortimanik_expenses_v4';
    const KEY_SET = 'hortimanik_settings_v4';

    let purchases = [], sales = [], expenses = [], settings = { metaDiaria:0, metaSemanal:0 };

    function loadState(){
      try{
        purchases = JSON.parse(localStorage.getItem(KEY_PUR)) || [];
        sales = JSON.parse(localStorage.getItem(KEY_SALES)) || [];
        expenses = JSON.parse(localStorage.getItem(KEY_EXP)) || [];
        settings = JSON.parse(localStorage.getItem(KEY_SET)) || settings;
      }catch(e){
        setStatus('Erro ao acessar localStorage (modo de privacidade?). Usando estado em memória. | ' + e.message, true);
        purchases = purchases || []; sales = sales || []; expenses = expenses || []; settings = settings || { metaDiaria:0, metaSemanal:0 };
      }
      settings.metaDiaria = parseNumber(settings.metaDiaria);
      settings.metaSemanal = parseNumber(settings.metaSemanal);
      if(qs('#metaDiaria')) qs('#metaDiaria').value = settings.metaDiaria ? Number(settings.metaDiaria).toFixed(2) : '';
      if(qs('#metaSemanal')) qs('#metaSemanal').value = settings.metaSemanal ? Number(settings.metaSemanal).toFixed(2) : '';
    }
    function saveState(){
      try{
        localStorage.setItem(KEY_PUR, JSON.stringify(purchases));
        localStorage.setItem(KEY_SALES, JSON.stringify(sales));
        localStorage.setItem(KEY_EXP, JSON.stringify(expenses));
        localStorage.setItem(KEY_SET, JSON.stringify(settings));
      }catch(e){
        setStatus('Aviso: não foi possível salvar em localStorage: ' + e.message, true);
      }
      updateStorageSize();
    }
    function updateStorageSize(){
      try{
        const used = new Blob([localStorage.getItem(KEY_PUR)||'', localStorage.getItem(KEY_SALES)||'', localStorage.getItem(KEY_EXP)||'', localStorage.getItem(KEY_SET)||'']).size;
        if(qs('#storageSize')) qs('#storageSize').textContent = Math.round(used/1024) + ' KB';
      }catch(e){ if(qs('#storageSize')) qs('#storageSize').textContent = '-'; }
    }

    /* ---------- CRUD Compras / Vendas / Despesas ---------- */
    function totalPurchases(){ return purchases.reduce((s,p)=> s + parseNumber(p.valor), 0); }

    function addPurchase(){
      try{
        const fornecedor = qs('#fornecedor') ? qs('#fornecedor').value.trim() : '';
        const valor = qs('#valorCompraInput') ? parseNumber(qs('#valorCompraInput').value) : 0;
        const data = qs('#compraDataInput') && qs('#compraDataInput').value ? qs('#compraDataInput').value : getLocalDateString();
        if(!fornecedor){ alert('Informe o fornecedor.'); return; }
        if(valor <= 0){ alert('Informe um valor maior que zero.'); return; }
        purchases.push({ id: Date.now(), fornecedor, valor, data });
        saveState(); renderAll();
        if(qs('#fornecedor')) qs('#fornecedor').value=''; if(qs('#valorCompraInput')) qs('#valorCompraInput').value=''; if(qs('#compraDataInput')) qs('#compraDataInput').value='';
      }catch(e){ setStatus('Erro addPurchase: ' + e.message, true); }
    }
    function removePurchase(id){ purchases = purchases.filter(p=> p.id !== Number(id)); saveState(); renderAll(); }
    function renderPurchases(){
      const tbody = qs('#tabelaCompras'); if(!tbody) return;
      tbody.innerHTML = '';
      purchases.slice().reverse().forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-1">${p.data}</td><td class="py-1">${escapeHtml(p.fornecedor)}</td><td class="py-1 text-right">${formatCurrency(p.valor)}</td><td class="py-1"><button class="small-btn rounded bg-rose-700" onclick="removePurchase(${p.id})">Remover</button></td>`;
        tbody.appendChild(tr);
      });
      if(qs('#somaCompras')) qs('#somaCompras').textContent = formatCurrency(totalPurchases());
    }

    function addSale(){
      try{
        const data = qs('#vendaDataInput') && qs('#vendaDataInput').value ? qs('#vendaDataInput').value : getLocalDateString();
        const valor = qs('#vendaValorInput') ? parseNumber(qs('#vendaValorInput').value) : 0;
        const metodo = qs('#vendaMetodoInput') ? qs('#vendaMetodoInput').value : '';
        if(valor <= 0){ alert('Informe o valor da venda.'); return; }
        sales.push({ id: Date.now(), data, valor, metodo });
        saveState(); renderAll();
        if(qs('#vendaValorInput')) qs('#vendaValorInput').value=''; if(qs('#vendaDataInput')) qs('#vendaDataInput').value='';
      }catch(e){ setStatus('Erro addSale: ' + e.message, true); }
    }
    function removeSale(id){ sales = sales.filter(s=> s.id !== Number(id)); saveState(); renderAll(); }
    function renderSales(){
      const tbody = qs('#tabelaVendas'); if(!tbody) return;
      tbody.innerHTML = '';
      sales.slice().reverse().forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-1">${s.data}</td><td class="py-1 text-right">${formatCurrency(s.valor)}</td><td class="py-1">${escapeHtml(s.metodo)}</td><td class="py-1"><button class="small-btn rounded bg-rose-700" onclick="removeSale(${s.id})">Remover</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function addExpense(){
      try{
        const data = qs('#despesaDataInput') && qs('#despesaDataInput').value ? qs('#despesaDataInput').value : getLocalDateString();
        const valor = qs('#despesaValorInput') ? parseNumber(qs('#despesaValorInput').value) : 0;
        const desc = qs('#despesaDescInput') ? qs('#despesaDescInput').value : '';
        if(valor <= 0){ alert('Informe o valor da despesa.'); return; }
        expenses.push({ id: Date.now(), data, valor, desc });
        saveState(); renderAll();
        if(qs('#despesaValorInput')) qs('#despesaValorInput').value=''; if(qs('#despesaDescInput')) qs('#despesaDescInput').value=''; if(qs('#despesaDataInput')) qs('#despesaDataInput').value='';
      }catch(e){ setStatus('Erro addExpense: ' + e.message, true); }
    }
    function removeExpense(id){ expenses = expenses.filter(e=> e.id !== Number(id)); saveState(); renderAll(); }
    function renderExpenses(){
      const tbody = qs('#tabelaDespesas'); if(!tbody) return;
      tbody.innerHTML = '';
      expenses.slice().reverse().forEach(e=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-1">${e.data}</td><td class="py-1 text-right">${formatCurrency(e.valor)}</td><td class="py-1">${escapeHtml(e.desc)}</td><td class="py-1"><button class="small-btn rounded bg-rose-700" onclick="removeExpense(${e.id})">Remover</button></td>`;
        tbody.appendChild(tr);
      });
    }

    /* ---------- AGREGADOS POR DIA/SEMANA ---------- */
    function vendasNoDia(date){ return sales.filter(s=> s.data === date).reduce((a,b)=> a + parseNumber(b.valor), 0); }
    function despesasNoDia(date){ return expenses.filter(e=> e.data === date).reduce((a,b)=> a + parseNumber(b.valor), 0); }
    function comprasNoDia(date){ return purchases.filter(p=> p.data === date).reduce((a,b)=> a + parseNumber(b.valor), 0); }

    function weekRange(ref){
      const now = ref ? new Date(ref) : new Date();
      const day = now.getDay();
      const diffToMon = (day === 0 ? -6 : 1 - day);
      const monday = new Date(now);
      monday.setDate(now.getDate() + diffToMon);
      monday.setHours(0,0,0,0);
      const arr = [];
      for(let i=0;i<6;i++){
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        arr.push(d.toISOString().slice(0,10));
      }
      return arr;
    }

    /* ---------- CHART ---------- */
    let weekChart = null;
    function updateWeekChart(labels, vendasData, metasData){
      try{
        const canvas = qs('#chartSemana'); if(!canvas) return;
        const ctx = canvas.getContext('2d');
        if(typeof Chart === 'undefined'){ setStatus('Chart.js não carregado — gráfico desativado (funcionalidade OK).', false); return; }
        if(weekChart){
          weekChart.data.labels = labels;
          weekChart.data.datasets[0].data = vendasData;
          weekChart.data.datasets[1].data = metasData;
          weekChart.update();
          return;
        }
        weekChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label:'Vendas (R$)', data: vendasData, backgroundColor: 'rgba(16,185,129,0.9)' },
              { label:'Meta diária (R$)', data: metasData, type:'line', borderColor:'#ef4444', borderWidth:2, fill:false, tension:0.2 }
            ]
          },
          options: { responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:false }, scales:{ y:{ beginAtZero:true } } }
        });
      }catch(e){ setStatus('Erro gráfico: ' + e.message, true); }
    }

    /* ---------- RENDER ÚNICO (DASHBOARD) ---------- */
    function renderDashboard(){
      try{
        if(qs('#totalCompras')) qs('#totalCompras').textContent = formatCurrency(totalPurchases());

        const margemInput = qs('#margemInput');
        const margem = margemInput ? parseNumber(margemInput.value) : 0;
        const vendaEstim = (settings.lastVendaEstim !== undefined) ? settings.lastVendaEstim : (totalPurchases() * (1 + (margem||0)/100));
        if(qs('#valorVendaEstimado')) qs('#valorVendaEstimado').textContent = formatCurrency(vendaEstim);
        if(qs('#precoVendaEstim')) qs('#precoVendaEstim').textContent = formatCurrency(vendaEstim);
        if(qs('#projecaoDiaria')) qs('#projecaoDiaria').textContent = formatCurrency(vendaEstim / 6);

        if(settings.metaDiaria && qs('#metaDiaria')) qs('#metaDiaria').value = Number(settings.metaDiaria).toFixed(2);
        if(settings.metaSemanal && qs('#metaSemanal')) qs('#metaSemanal').value = Number(settings.metaSemanal).toFixed(2);

        const today = getLocalDateString();
        const vendasHoje = vendasNoDia(today);
        const despesasHoje = despesasNoDia(today);
        const custoComprasHoje = comprasNoDia(today);
        const lucroLiquido = vendasHoje - despesasHoje - custoComprasHoje;

        if(qs('#vendasHoje')) qs('#vendasHoje').textContent = formatCurrency(vendasHoje);
        if(qs('#vendasHojeResumo')) qs('#vendasHojeResumo').textContent = formatCurrency(vendasHoje);
        if(qs('#despesasHojeResumo')) qs('#despesasHojeResumo').textContent = formatCurrency(despesasHoje);
        if(qs('#custoComprasHoje')) qs('#custoComprasHoje').textContent = formatCurrency(custoComprasHoje);
        if(qs('#lucroLiquido')) qs('#lucroLiquido').textContent = formatCurrency(lucroLiquido);
        if(qs('#gastosHoje')) qs('#gastosHoje').textContent = formatCurrency(despesasHoje);

        // estimados
        const lucroBrutoEstim = vendaEstim - totalPurchases();
        const totalExpensesAll = expenses.reduce((s,e)=> s + parseNumber(e.valor), 0);
        const lucroLiquidoEstim = vendaEstim - totalPurchases() - totalExpensesAll;
        if(qs('#lucroBrutoEstim')) qs('#lucroBrutoEstim').textContent = formatCurrency(lucroBrutoEstim);
        if(qs('#lucroLiquidoEstim')) qs('#lucroLiquidoEstim').textContent = formatCurrency(lucroLiquidoEstim);

        // meta diaria
        const metaDia = qs('#metaDiaria') ? parseNumber(qs('#metaDiaria').value) : 0;
        const faltante = Math.max(0, metaDia - vendasHoje);
        if(qs('#metaStatus')) qs('#metaStatus').textContent = `Meta: ${formatCurrency(metaDia)} — Faltam: ${formatCurrency(faltante)}`;

        // semana
        const dates = weekRange();
        const vendasSemana = dates.reduce((s,d)=> s + vendasNoDia(d), 0);
        const despesasSemana = dates.reduce((s,d)=> s + despesasNoDia(d), 0);
        const comprasSemana = dates.reduce((s,d)=> s + comprasNoDia(d), 0);
        const metaSemana = qs('#metaSemanal') ? parseNumber(qs('#metaSemanal').value) : 0;
        const faltanteSemana = Math.max(0, metaSemana - vendasSemana);
        if(qs('#vendasSemana')) qs('#vendasSemana').textContent = formatCurrency(vendasSemana);
        if(qs('#metaSemanaStatus')) qs('#metaSemanaStatus').textContent = `Meta semanal: ${formatCurrency(metaSemana)} — Faltam: ${formatCurrency(faltanteSemana)}`;
        if(qs('#gastosSemana')) qs('#gastosSemana').textContent = formatCurrency(despesasSemana);
        if(qs('#lucroSemana')) qs('#lucroSemana').textContent = formatCurrency(vendasSemana - comprasSemana - despesasSemana);

        // chart
        const labels = dates.map(d => { const parts = d.split('-'); return parts[1] + '/' + parts[2]; });
        const vendasData = dates.map(d => vendasNoDia(d));
        const metasData = dates.map(_ => metaDia);
        updateWeekChart(labels, vendasData, metasData);

        setStatus('HORTIMANIK pronto — tudo carregado.', false);
      }catch(e){
        setStatus('Erro em renderDashboard: ' + e.message, true);
        console.error(e);
      }
    }

    function renderAll(){ renderPurchases(); renderSales(); renderExpenses(); renderDashboard(); }

    /* ---------- EXPORT / CLEAR ---------- */
    function exportCsv(){
      try{
        const rows = [['tipo','data','valor','detalhes']];
        purchases.forEach(p=> rows.push(['compra', p.data, p.valor, p.fornecedor]));
        sales.forEach(s=> rows.push(['venda', s.data, s.valor, s.metodo]));
        expenses.forEach(e=> rows.push(['despesa', e.data, e.valor, e.desc]));
        const csv = rows.map(r => r.map(c=> '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'hortimanik_export.csv'; a.click(); URL.revokeObjectURL(url);
      }catch(e){ setStatus('Erro exportCsv: ' + e.message, true); }
    }
    function clearAll(){ if(confirm('Apagar todos os dados locais?')){ purchases=[]; sales=[]; expenses=[]; settings={metaDiaria:0,metaSemanal:0}; saveState(); renderAll(); setStatus('Dados apagados.', false); } }

    /* ---------- BINDINGS ---------- */
    document.addEventListener('DOMContentLoaded', function(){
      try{
        setStatus('Carregando dados...', false);
        loadState();

        // tabs: usa querySelectorAll (resiliente)
        const tabBtns = qsa('.tab-btn');
        if(tabBtns.length === 0) console.warn('Nenhum botão de tab detectado.');
        tabBtns.forEach(function(b){
          b.addEventListener('click', function(){
            qsa('.tab-content').forEach(function(t){ t.classList.add('hidden'); });
            var id = b.getAttribute('data-tab');
            var target = qs('#' + id);
            if(target) target.classList.remove('hidden');
            if(id === 'dashboard') renderDashboard();
          });
        });

        // eventos principais (checa existência antes)
        if(qs('#adicionarCompra')) qs('#adicionarCompra').addEventListener('click', addPurchase);
        if(qs('#calcularVendaEstim')) qs('#calcularVendaEstim').addEventListener('click', function(){
          var margemInput = qs('#margemInput');
          var margem = margemInput ? parseNumber(margemInput.value) : 0;
          var total = totalPurchases();
          var vendaEstim = total * (1 + margem/100);
          if(qs('#precoVendaEstim')) qs('#precoVendaEstim').textContent = formatCurrency(vendaEstim);
          if(qs('#projecaoDiaria')) qs('#projecaoDiaria').textContent = formatCurrency(vendaEstim / 6);
          if(!settings.metaDiaria){ settings.metaDiaria = Number((vendaEstim/6).toFixed(2)); if(qs('#metaDiaria')) qs('#metaDiaria').value = settings.metaDiaria.toFixed(2); }
          if(!settings.metaSemanal){ settings.metaSemanal = Number(vendaEstim.toFixed(2)); if(qs('#metaSemanal')) qs('#metaSemanal').value = settings.metaSemanal.toFixed(2); }
          settings.lastVendaEstim = vendaEstim;
          saveState(); renderAll();
        });
        if(qs('#adicionarVenda')) qs('#adicionarVenda').addEventListener('click', addSale);
        if(qs('#adicionarDespesa')) qs('#adicionarDespesa').addEventListener('click', addExpense);
        if(qs('#exportCsvBtn')) qs('#exportCsvBtn').addEventListener('click', exportCsv);
        if(qs('#limparDados')) qs('#limparDados').addEventListener('click', clearAll);
        if(qs('#salvarMetas')) qs('#salvarMetas').addEventListener('click', function(){
          settings.metaDiaria = qs('#metaDiaria') ? parseNumber(qs('#metaDiaria').value) : 0;
          settings.metaSemanal = qs('#metaSemanal') ? parseNumber(qs('#metaSemanal').value) : 0;
          saveState(); renderDashboard(); alert('Metas salvas.');
        });

        // expose for inline buttons
        window.removePurchase = removePurchase; window.removeSale = removeSale; window.removeExpense = removeExpense;

        // initial view
        qsa('.tab-content').forEach(function(t){ t.classList.add('hidden'); });
        if(qs('#dashboard')) qs('#dashboard').classList.remove('hidden');

        renderAll();
        updateStorageSize();

        setStatus('Carregado com sucesso.', false);
      }catch(e){
        setStatus('Erro inicial: ' + e.message, true);
        console.error(e);
      }
    });
  </script>
</body>
</html>
