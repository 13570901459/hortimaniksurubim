<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HORTIMANIK - Dashboard Profissional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0f1724; }
    .card { background: linear-gradient(180deg,#0b1220 0%, #07101a 100%); border: 1px solid rgba(255,255,255,0.03); }
    .btn-red { background: linear-gradient(180deg,#ef4444,#dc2626); }
    .btn-red:hover { filter: brightness(0.9); }
    .small-btn { font-size: 12px; padding: 4px 8px; }
    input[type="text"], input[type="date"] { -moz-appearance: textfield; }
  </style>
</head>
<body class="text-slate-200 font-sans">
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-80 p-6 bg-slate-900 border-r border-slate-800">
      <h1 class="text-2xl font-bold text-red-500">HORTIMANIK</h1>
      <p class="text-sm text-slate-400 mb-4">Sistema de vendas & controle — Seg a Sáb</p>
      <nav class="space-y-2">
        <button data-tab="dashboard" class="tab-btn w-full text-left px-3 py-2 rounded card">Dashboard</button>
        <button data-tab="compras" class="tab-btn w-full text-left px-3 py-2 rounded card">Registrar Compras</button>
        <button data-tab="vendas" class="tab-btn w-full text-left px-3 py-2 rounded card">Registrar Vendas</button>
        <button data-tab="despesas" class="tab-btn w-full text-left px-3 py-2 rounded card">Registrar Despesas</button>
        <button data-tab="relatorios" class="tab-btn w-full text-left px-3 py-2 rounded card">Relatórios</button>
        <button data-tab="config" class="tab-btn w-full text-left px-3 py-2 rounded card">Config / Export</button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6 overflow-y-auto">
      <!-- Dashboard -->
      <section id="dashboard" class="tab-content">
        <div class="flex justify-between items-start gap-4">
          <div>
            <h2 class="text-2xl font-bold">Dashboard profissional</h2>
            <p class="text-sm text-slate-400">Visão rápida: compras, projeção, meta diária, vendas x meta e despesas.</p>
          </div>
          <div class="space-x-2">
            <label class="text-sm text-slate-400">Meta diária (R$)</label>
            <input id="metaDiaria" type="text" inputmode="decimal" class="px-3 py-1 rounded bg-slate-800 text-slate-200 w-36 text-right" />
            <label class="text-sm text-slate-400 ml-2">Meta semanal (R$)</label>
            <input id="metaSemanal" type="text" inputmode="decimal" class="px-3 py-1 rounded bg-slate-800 text-slate-200 w-36 text-right" />
            <button id="salvarMetas" class="px-3 py-1 rounded btn-red text-white ml-2">Salvar</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mt-6">
          <div class="p-4 rounded card shadow col-span-2">
            <div class="text-xs text-slate-400">Total compras (fornecedores)</div>
            <div id="totalCompras" class="text-2xl font-bold text-slate-100">R$ 0,00</div>
            <div class="text-sm text-slate-400">(soma de todos os registros de compra)</div>
          </div>

          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Valor venda estimado (com margem)</div>
            <div id="valorVendaEstimado" class="text-2xl font-bold text-red-400">R$ 0,00</div>
            <div class="text-sm text-slate-400">(total compras + margem)</div>
          </div>

          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Projeção diária (Venda estimada ÷ 6)</div>
            <div id="projecaoDiaria" class="text-2xl font-bold text-sky-400">R$ 0,00</div>
            <div class="text-sm text-slate-400">Seg → Sáb</div>
          </div>

          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Vendas (hoje)</div>
            <div id="vendasHoje" class="text-2xl font-bold text-green-400">R$ 0,00</div>
            <div id="metaStatus" class="text-sm text-slate-400 mt-1">Meta: R$ 0,00 — Faltam: R$ 0,00</div>
          </div>

          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Gastos (hoje)</div>
            <div id="gastosHoje" class="text-2xl font-bold text-yellow-400">R$ 0,00</div>
            <div class="text-sm text-slate-400">(despesas registradas hoje)</div>
          </div>

          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Lucro bruto estimado</div>
            <div id="lucroBrutoEstim" class="text-2xl font-bold text-indigo-300">R$ 0,00</div>
            <div class="text-sm text-slate-400">(venda estimada - custo das compras)</div>
          </div>
        </div>

        <!-- Novos cards semanais -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Total vendas (semana)</div>
            <div id="vendasSemana" class="text-2xl font-bold text-green-400">R$ 0,00</div>
            <div id="metaSemanaStatus" class="text-sm text-slate-400 mt-1">Meta semanal: R$ 0,00 — Faltam: R$ 0,00</div>
          </div>
          <div class="p-4 rounded card shadow">
            <div class="text-xs text-slate-400">Despesas (semana)</div>
            <div id="gastosSemana" class="text-2xl font-bold text-yellow-400">R$ 0,00</div>
            <div class="text-sm text-slate-400">(soma de todas as despesas da semana)</div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-6">
          <div class="p-4 rounded card shadow h-72">
            <canvas id="chartSemana" class="w-full h-full"></canvas>
          </div>
          <div class="p-4 rounded card shadow">
            <h3 class="text-lg font-semibold">Resumo financeiro (hoje)</h3>
            <div class="mt-3 text-sm text-slate-400">Vendas: <strong id="vendasHojeResumo">R$ 0,00</strong></div>
            <div class="text-sm text-slate-400">Despesas: <strong id="despesasHojeResumo">R$ 0,00</strong></div>
            <div class="text-sm text-slate-400">Custo compras do dia: <strong id="custoComprasHoje">R$ 0,00</strong></div>
            <div class="text-xl font-bold mt-3">Lucro líquido (hoje): <span id="lucroLiquido">R$ 0,00</span></div>
            <div class="mt-3 text-sm text-slate-400">Lucro líquido estimado (venda estimada - compras - despesas totais): <strong id="lucroLiquidoEstim">R$ 0,00</strong></div>
          </div>
        </div>
      </section>

      <!-- Compras -->
      <section id="compras" class="hidden tab-content mt-6">
        <h2 class="text-xl font-bold mb-3 text-red-400">Registrar Compras</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <input id="fornecedor" placeholder="Nome do fornecedor" class="p-2 rounded bg-slate-800 text-slate-200" />
          <input id="valorCompraInput" type="text" inputmode="decimal" placeholder="Valor da compra (R$)" class="p-2 rounded bg-slate-800 text-slate-200 text-right" />
          <input id="compraDataInput" type="date" class="p-2 rounded bg-slate-800 text-slate-200" />
          <button id="adicionarCompra" class="btn-red px-4 py-2 rounded font-bold">Adicionar compra</button>
        </div>

        <div class="mt-4 p-4 rounded card">
          <h3 class="font-semibold">Compras registradas</h3>
          <div class="mt-2 overflow-auto max-h-64">
            <table class="w-full text-sm text-left">
              <thead class="text-slate-400 text-xs"><tr><th>Data</th><th>Fornecedor</th><th>Valor</th><th></th></tr></thead>
              <tbody id="tabelaCompras"></tbody>
            </table>
          </div>
          <div class="mt-3 text-sm text-slate-400">Total compras: <strong id="somaCompras">R$ 0,00</strong></div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-2">
            <input id="margemInput" type="text" inputmode="decimal" step="0.1" placeholder="Margem % (ex: 30)" class="p-2 rounded bg-slate-800 text-slate-200 text-right" />
            <button id="calcularVendaEstim" class="px-4 py-2 rounded btn-red font-bold">Calcular venda estimada</button>
            <div class="text-slate-400 p-2">Preço venda estimado: <strong id="precoVendaEstim">R$ 0,00</strong></div>
          </div>
        </div>
      </section>

      <!-- Vendas -->
      <section id="vendas" class="hidden tab-content mt-6">
        <h2 class="text-xl font-bold mb-3 text-red-400">Registrar Vendas</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <input id="vendaDataInput" type="date" class="p-2 rounded bg-slate-800 text-slate-200" />
          <input id="vendaValorInput" type="text" inputmode="decimal" placeholder="Valor vendido (R$)" class="p-2 rounded bg-slate-800 text-slate-200 text-right" />
          <select id="vendaMetodoInput" class="p-2 rounded bg-slate-800 text-slate-200"><option>PIX</option><option>Cartão</option><option>Dinheiro</option></select>
          <button id="adicionarVenda" class="btn-red px-4 py-2 rounded font-bold">Registrar venda</button>
        </div>

        <div class="mt-4 p-4 rounded card">
          <h3 class="font-semibold">Vendas registradas</h3>
          <div class="mt-2 overflow-auto max-h-64">
            <table class="w-full text-sm text-left">
              <thead class="text-slate-400 text-xs"><tr><th>Data</th><th>Valor</th><th>Método</th><th></th></tr></thead>
              <tbody id="tabelaVendas"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Despesas -->
      <section id="despesas" class="hidden tab-content mt-6">
        <h2 class="text-xl font-bold mb-3 text-red-400">Registrar Despesas</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <input id="despesaDataInput" type="date" class="p-2 rounded bg-slate-800 text-slate-200" />
          <input id="despesaValorInput" type="text" inputmode="decimal" placeholder="Valor gasto (R$)" class="p-2 rounded bg-slate-800 text-slate-200 text-right" />
          <input id="despesaDescInput" placeholder="Descrição" class="p-2 rounded bg-slate-800 text-slate-200" />
          <button id="adicionarDespesa" class="btn-red px-4 py-2 rounded font-bold">Registrar despesa</button>
        </div>

        <div class="mt-4 p-4 rounded card">
          <h3 class="font-semibold">Despesas registradas</h3>
          <div class="mt-2 overflow-auto max-h-64">
            <table class="w-full text-sm text-left">
              <thead class="text-slate-400 text-xs"><tr><th>Data</th><th>Valor</th><th>Descrição</th><th></th></tr></thead>
              <tbody id="tabelaDespesas"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Relatórios -->
      <section id="relatorios" class="hidden tab-content mt-6">
        <h2 class="text-xl font-bold mb-3 text-red-400">Relatórios & Export</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <button id="exportCsvBtn" class="btn-red px-4 py-2 rounded font-bold">Exportar CSV</button>
          <button id="limparDados" class="px-4 py-2 rounded bg-rose-700">Limpar todos os dados</button>
          <div class="text-slate-400">Os dados ficam somente no seu navegador (localStorage).</div>
        </div>
      </section>

      <!-- Config -->
      <section id="config" class="hidden tab-content mt-6">
        <h2 class="text-xl font-bold mb-3 text-red-400">Configurações</h2>
        <div class="p-4 rounded card">
          <div class="text-slate-400">Storage size: <span id="storageSize">-</span></div>
        </div>
      </section>

    </main>
  </div>

  <script>
    // Helpers
    const qs = s => document.querySelector(s);
    const qsa = s => document.querySelectorAll(s);
    const pad = (n)=> String(n).padStart(2,'0');
    const formatCurrency = v => {
      const n = Number(v) || 0; return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    };
    const fmt = v => Number(v||0).toFixed(2);

    function parseNumber(input){
      if(input===undefined || input===null) return 0;
      if(typeof input === 'number') return input;
      let s = String(input).trim();
      if(s==='') return 0;
      // remove currency sign and spaces
      s = s.replace(/[^0-9,.-]/g,'');
      const hasDot = s.indexOf('.') !== -1;
      const hasComma = s.indexOf(',') !== -1;
      if(hasDot && hasComma){ s = s.replace(/\./g,'').replace(/,/g,'.'); }
      else { s = s.replace(/,/g,'.'); }
      const n = parseFloat(s);
      return isNaN(n)?0:n;
    }

    function getLocalDateString(d = new Date()){
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // weekRange: segunda -> sabado (6 dias)
    function weekRange(ref){ const now = ref ? new Date(ref) : new Date(); const day = now.getDay(); const diffToMon = (day===0? -6 : 1 - day); const monday = new Date(now); monday.setDate(now.getDate() + diffToMon); monday.setHours(0,0,0,0); const arr=[]; for(let i=0;i<6;i++){ const d=new Date(monday); d.setDate(monday.getDate()+i); arr.push(d.toISOString().slice(0,10)); } return arr; }

    // Storage keys
    const KEY_PUR = 'hortimanik_purchases_v4';
    const KEY_SALES = 'hortimanik_sales_v4';
    const KEY_EXP = 'hortimanik_expenses_v4';
    const KEY_SET = 'hortimanik_settings_v4';

    // state
    let purchases = [];
    let sales = [];
    let expenses = [];
    let settings = { metaDiaria: 0, metaSemanal: 0 };

    function loadState(){
      try{ purchases = JSON.parse(localStorage.getItem(KEY_PUR)) || []; }catch(e){ purchases = []; }
      try{ sales = JSON.parse(localStorage.getItem(KEY_SALES)) || []; }catch(e){ sales = []; }
      try{ expenses = JSON.parse(localStorage.getItem(KEY_EXP)) || []; }catch(e){ expenses = []; }
      try{ settings = JSON.parse(localStorage.getItem(KEY_SET)) || settings; }catch(e){ settings = settings; }

      settings.metaDiaria = parseNumber(settings.metaDiaria);
      settings.metaSemanal = parseNumber(settings.metaSemanal);

      qs('#metaDiaria').value = settings.metaDiaria ? Number(settings.metaDiaria).toFixed(2) : '';
      qs('#metaSemanal').value = settings.metaSemanal ? Number(settings.metaSemanal).toFixed(2) : '';
    }

    function saveState(){
      localStorage.setItem(KEY_PUR, JSON.stringify(purchases));
      localStorage.setItem(KEY_SALES, JSON.stringify(sales));
      localStorage.setItem(KEY_EXP, JSON.stringify(expenses));
      localStorage.setItem(KEY_SET, JSON.stringify(settings));
      updateStorageSize();
    }

    function updateStorageSize(){
      try{
        const used = new Blob([localStorage.getItem(KEY_PUR)||'', localStorage.getItem(KEY_SALES)||'', localStorage.getItem(KEY_EXP)||'', localStorage.getItem(KEY_SET)||'']).size;
        qs('#storageSize').textContent = Math.round(used/1024) + ' KB';
      }catch(e){ qs('#storageSize').textContent='-'; }
    }

    // Purchases
    function addPurchase(){
      const fornecedor = qs('#fornecedor').value.trim();
      const valor = parseNumber(qs('#valorCompraInput').value);
      const data = qs('#compraDataInput').value || getLocalDateString();
      if(!fornecedor){ alert('Informe o fornecedor.'); return; }
      if(valor <= 0){ alert('Informe um valor maior que zero.'); return; }
      purchases.push({ id: Date.now(), fornecedor, valor, data });
      saveState(); renderAll();
      qs('#fornecedor').value=''; qs('#valorCompraInput').value=''; qs('#compraDataInput').value='';
    }

    function removePurchase(id){ purchases = purchases.filter(p=> p.id !== Number(id)); saveState(); renderAll(); }
    function renderPurchases(){
      const tbody = qs('#tabelaCompras'); tbody.innerHTML = '';
      purchases.slice().reverse().forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-1">${p.data}</td><td class="py-1">${escapeHtml(p.fornecedor)}</td><td class="py-1 text-right">${formatCurrency(p.valor)}</td><td class="py-1"><button class="small-btn rounded bg-rose-700" onclick="removePurchase(${p.id})">Remover</button></td>`;
        tbody.appendChild(tr);
      });
      qs('#somaCompras').textContent = formatCurrency(totalPurchases());
    }
    function totalPurchases(){ return purchases.reduce((s,p)=> s + parseNumber(p.valor), 0); }

    // Sales
    function addSale(){
      const data = qs('#vendaDataInput').value || getLocalDateString();
      const valor = parseNumber(qs('#vendaValorInput').value);
      const metodo = qs('#vendaMetodoInput').value;
      if(valor <= 0){ alert('Informe o valor da venda.'); return; }
      sales.push({ id: Date.now(), data, valor, metodo }); saveState(); renderAll(); qs('#vendaValorInput').value=''; qs('#vendaDataInput').value='';
    }
    function removeSale(id){ sales = sales.filter(s=> s.id !== Number(id)); saveState(); renderAll(); }
    function renderSales(){ const tbody = qs('#tabelaVendas'); tbody.innerHTML=''; sales.slice().reverse().forEach(s=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td class="py-1">${s.data}</td><td class="py-1 text-right">${formatCurrency(s.valor)}</td><td class="py-1">${escapeHtml(s.metodo)}</td><td class="py-1"><button class="small-btn rounded bg-rose-700" onclick="removeSale(${s.id})">Remover</button></td>`; tbody.appendChild(tr); }); }

    // Expenses
    function addExpense(){
      const data = qs('#despesaDataInput').value || getLocalDateString();
      const valor = parseNumber(qs('#despesaValorInput').value);
      const desc = qs('#despesaDescInput').value || '';
      if(valor <= 0){ alert('Informe o valor da despesa.'); return; }
      expenses.push({ id: Date.now(), data, valor, desc }); saveState(); renderAll(); qs('#despesaValorInput').value=''; qs('#despesaDescInput').value=''; qs('#despesaDataInput').value='';
    }
    function removeExpense(id){ expenses = expenses.filter(e=> e.id !== Number(id)); saveState(); renderAll(); }
    function renderExpenses(){ const tbody = qs('#tabelaDespesas'); tbody.innerHTML=''; expenses.slice().reverse().forEach(e=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td class="py-1">${e.data}</td><td class="py-1 text-right">${formatCurrency(e.valor)}</td><td class="py-1">${escapeHtml(e.desc)}</td><td class="py-1"><button class="small-btn rounded bg-rose-700" onclick="removeExpense(${e.id})">Remover</button></td>`; tbody.appendChild(tr); }); }

    // Day aggregations
    function vendasNoDia(date){ return sales.filter(s=> s.data === date).reduce((a,b)=> a + parseNumber(b.valor), 0); }
    function despesasNoDia(date){ return expenses.filter(e=> e.data === date).reduce((a,b)=> a + parseNumber(b.valor), 0); }
    function comprasNoDia(date){ return purchases.filter(p=> p.data === date).reduce((a,b)=> a + parseNumber(b.valor), 0); }

    // Chart
    let weekChart = null;
    function updateWeekChart(labels, vendasData, metasData){
      const ctx = document.getElementById('chartSemana').getContext('2d');
      if(weekChart){
        weekChart.data.labels = labels;
        weekChart.data.datasets[0].data = vendasData;
        weekChart.data.datasets[1].data = metasData;
        weekChart.update();
        return;
      }
      weekChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label:'Vendas (R$)', data: vendasData, backgroundColor: 'rgba(16,185,129,0.9)' },
            { label:'Meta diária (R$)', data: metasData, type:'line', borderColor:'#ef4444', borderWidth:2, fill:false, tension:0.2 }
          ]
        },
        options: { responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:false }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    // One single renderDashboard (fixed + semanal)
    function renderDashboard(){
      // totals
      qs('#totalCompras').textContent = formatCurrency(totalPurchases());

      const margem = parseNumber(qs('#margemInput')?.value);
      const vendaEstim = (settings.lastVendaEstim !== undefined) ? settings.lastVendaEstim : (totalPurchases() * (1 + (margem||0)/100));
      qs('#valorVendaEstimado').textContent = formatCurrency(vendaEstim);
      qs('#precoVendaEstim').textContent = formatCurrency(vendaEstim);
      qs('#projecaoDiaria').textContent = formatCurrency(vendaEstim / 6);

      // ensure inputs reflect settings (do not overwrite user typing)
      if(settings.metaDiaria) qs('#metaDiaria').value = Number(settings.metaDiaria).toFixed(2);
      if(settings.metaSemanal) qs('#metaSemanal').value = Number(settings.metaSemanal).toFixed(2);

      const today = getLocalDateString();
      const vendasHoje = vendasNoDia(today);
      const despesasHoje = despesasNoDia(today);
      const custoComprasHoje = comprasNoDia(today);
      const lucroLiquido = vendasHoje - despesasHoje - custoComprasHoje;

      qs('#vendasHoje').textContent = formatCurrency(vendasHoje);
      qs('#vendasHojeResumo').textContent = formatCurrency(vendasHoje);
      qs('#despesasHojeResumo').textContent = formatCurrency(despesasHoje);
      qs('#custoComprasHoje').textContent = formatCurrency(custoComprasHoje);
      qs('#lucroLiquido').textContent = formatCurrency(lucroLiquido);
      qs('#gastosHoje').textContent = formatCurrency(despesasHoje);

      // lucro estimados
      const lucroBrutoEstim = vendaEstim - totalPurchases();
      qs('#lucroBrutoEstim').textContent = formatCurrency(lucroBrutoEstim);
      const totalExpensesAll = expenses.reduce((s,e)=> s + parseNumber(e.valor), 0);
      const lucroLiquidoEstim = vendaEstim - totalPurchases() - totalExpensesAll;
      qs('#lucroLiquidoEstim').textContent = formatCurrency(lucroLiquidoEstim);

      // meta status diário
      const metaDia = parseNumber(qs('#metaDiaria').value) || 0;
      const faltante = Math.max(0, metaDia - vendasHoje);
      qs('#metaStatus').textContent = `Meta: ${formatCurrency(metaDia)} — Faltam: ${formatCurrency(faltante)}`;

      // semanal
      const dates = weekRange();
      const vendasSemana = dates.reduce((s,d)=> s + vendasNoDia(d), 0);
      const despesasSemana = dates.reduce((s,d)=> s + despesasNoDia(d), 0);
      const metaSemana = parseNumber(qs('#metaSemanal').value) || 0;
      const faltanteSemana = Math.max(0, metaSemana - vendasSemana);

      qs('#vendasSemana').textContent = formatCurrency(vendasSemana);
      qs('#metaSemanaStatus').textContent = `Meta semanal: ${formatCurrency(metaSemana)} — Faltam: ${formatCurrency(faltanteSemana)}`;
      qs('#gastosSemana').textContent = formatCurrency(despesasSemana);

      // chart
      const labels = dates.map(d => { const [y,m,day] = d.split('-'); return m + '/' + day; });
      const vendasData = dates.map(d => vendasNoDia(d));
      const metasData = dates.map(_ => metaDia);
      updateWeekChart(labels, vendasData, metasData);
    }

    // Export / clear
    function exportCsv(){
      const rows = [['tipo','data','valor','detalhes']];
      purchases.forEach(p=> rows.push(['compra', p.data, p.valor, p.fornecedor]));
      sales.forEach(s=> rows.push(['venda', s.data, s.valor, s.metodo]));
      expenses.forEach(e=> rows.push(['despesa', e.data, e.valor, e.desc]));
      const csv = rows.map(r => r.map(c=> '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'hortimanik_export.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function clearAll(){ if(confirm('Apagar todos os dados locais?')){ purchases=[]; sales=[]; expenses=[]; settings={metaDiaria:0,metaSemanal:0}; saveState(); renderAll(); }}

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // ligar eventos
    document.addEventListener('DOMContentLoaded', ()=>{
      loadState();

      // show dashboard initially
      document.querySelectorAll('.tab-content').forEach(t=> t.classList.add('hidden'));
      document.getElementById('dashboard').classList.remove('hidden');

      // tabs
      qsa('.tab-btn').forEach(b=> b.addEventListener('click', ()=>{
        qsa('.tab-content').forEach(t=> t.classList.add('hidden'));
        document.getElementById(b.dataset.tab).classList.remove('hidden');
        if(b.dataset.tab === 'dashboard') renderDashboard();
      }));

      // buttons
      qs('#adicionarCompra').addEventListener('click', addPurchase);
      qs('#calcularVendaEstim').addEventListener('click', ()=>{
        const margem = parseNumber(qs('#margemInput').value);
        const total = totalPurchases();
        const vendaEstim = total * (1 + margem/100);
        qs('#precoVendaEstim').textContent = formatCurrency(vendaEstim);
        qs('#projecaoDiaria').textContent = formatCurrency(vendaEstim / 6);
        if(!settings.metaDiaria){ settings.metaDiaria = Number((vendaEstim/6).toFixed(2)); qs('#metaDiaria').value = settings.metaDiaria.toFixed(2); }
        if(!settings.metaSemanal){ settings.metaSemanal = Number(vendaEstim.toFixed(2)); qs('#metaSemanal').value = settings.metaSemanal.toFixed(2); }
        settings.lastVendaEstim = vendaEstim;
        saveState(); renderAll();
      });
      qs('#adicionarVenda').addEventListener('click', addSale);
      qs('#adicionarDespesa').addEventListener('click', addExpense);
      qs('#exportCsvBtn').addEventListener('click', exportCsv);
      qs('#limparDados').addEventListener('click', clearAll);
      qs('#salvarMetas').addEventListener('click', ()=>{
        settings.metaDiaria = parseNumber(qs('#metaDiaria').value);
        settings.metaSemanal = parseNumber(qs('#metaSemanal').value);
        saveState(); renderDashboard(); alert('Metas salvas.');
      });

      // initial render
      renderAll(); updateStorageSize();

      // expose removers for buttons in rows
      window.removePurchase = removePurchase; window.removeSale = removeSale; window.removeExpense = removeExpense;

      if(typeof Chart === 'undefined') console.warn('Chart.js não carregado — verifique conexão.');
    });

    function renderAll(){ renderPurchases(); renderSales(); renderExpenses(); renderDashboard(); }
  </script>
</body>
</html>
